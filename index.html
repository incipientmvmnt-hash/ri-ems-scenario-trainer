<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0e1a">
<title>RI EMS Scenario Trainer</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{overflow-y:scroll;-webkit-text-size-adjust:100%}
body{font-family:-apple-system,SF Pro,Inter,system-ui,sans-serif;background:#0a0e1a;color:#fff;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  touch-action:pan-y;min-height:100dvh}
.container{max-width:600px;margin:0 auto;padding:16px}
h1{font-size:1.6em;text-align:center;margin:20px 0 4px}
.subtitle{text-align:center;color:#8b92a8;margin-bottom:24px;font-size:.95em}
.card{background:#141929;border-radius:12px;padding:16px;margin-bottom:12px;transition:all .2s;cursor:pointer;border:2px solid transparent}
.card:active{transform:scale(.98)}
.card.selected{border-color:#d9534f}
.level-cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.level-card{text-align:center;padding:20px 12px;font-weight:600;font-size:1.1em}
.level-card .desc{font-size:.75em;font-weight:400;color:#8b92a8;margin-top:6px}
.level-card[data-level="E"]{border-color:#f0ad4e;color:#f0ad4e}
.level-card[data-level="E"].selected{background:rgba(240,173,78,.15);border-color:#f0ad4e}
.level-card[data-level="A"]{border-color:#34c759;color:#34c759}
.level-card[data-level="A"].selected{background:rgba(52,199,89,.15);border-color:#34c759}
.level-card[data-level="C"]{border-color:#4a9eff;color:#4a9eff}
.level-card[data-level="C"].selected{background:rgba(74,158,255,.15);border-color:#4a9eff}
.level-card[data-level="P"]{border-color:#d9534f;color:#d9534f}
.level-card[data-level="P"].selected{background:rgba(217,83,79,.15);border-color:#d9534f}
.btn{display:block;width:100%;padding:14px;border:none;border-radius:12px;font-size:1em;font-weight:600;cursor:pointer;transition:all .2s;text-align:center;margin-top:12px}
.btn:active{transform:scale(.97)}
.btn-primary{background:#d9534f;color:#fff}
.btn-primary:disabled{background:#333;color:#666;cursor:not-allowed}
.btn-secondary{background:#1e2440;color:#fff;border:1px solid #2a3154}
.btn-small{display:inline-block;width:auto;padding:8px 16px;font-size:.9em;margin:4px}
.progress-bar{display:flex;gap:4px;margin-bottom:20px}
.progress-step{flex:1;text-align:center;font-size:.7em;color:#8b92a8;padding-bottom:8px;border-bottom:3px solid #1e2440}
.progress-step.active{color:#d9534f;border-color:#d9534f}
.progress-step.done{color:#34c759;border-color:#34c759}
.narrative{background:#141929;border-radius:12px;padding:16px;margin-bottom:16px;line-height:1.6;font-size:.95em}
.narrative .label{color:#d9534f;font-weight:600;font-size:.8em;text-transform:uppercase;margin-bottom:6px}
.vitals-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:12px 0}
.vital{background:#0d1020;border-radius:8px;padding:8px;text-align:center}
.vital .val{font-size:1.1em;font-weight:600}
.vital .lbl{font-size:.7em;color:#8b92a8;margin-top:2px}
.option{background:#141929;border-radius:12px;padding:14px 16px;margin-bottom:8px;cursor:pointer;border:2px solid #1e2440;transition:all .2s;line-height:1.4}
.option:active{transform:scale(.98)}
.option.selected{border-color:#4a9eff;background:rgba(74,158,255,.1)}
.option.correct{border-color:#34c759;background:rgba(52,199,89,.15)}
.option.incorrect{border-color:#d9534f;background:rgba(217,83,79,.15)}
.option.missed{border-color:#f0ad4e;background:rgba(240,173,78,.1)}
.option .indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px;vertical-align:middle}
.option.correct .indicator{background:#34c759}
.option.incorrect .indicator{background:#d9534f}
.option.missed .indicator{background:#f0ad4e}
.explanation{font-size:.85em;color:#8b92a8;margin-top:8px;padding:10px;background:#0d1020;border-radius:8px;line-height:1.5}
.explanation .ref{color:#4a9eff;font-weight:500}
.question-prompt{font-size:1em;font-weight:500;margin-bottom:12px;line-height:1.5}
.multi-hint{font-size:.8em;color:#8b92a8;margin-bottom:8px}
.score-circle{width:120px;height:120px;border-radius:50%;margin:20px auto;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:2em;font-weight:700}
.score-good{background:rgba(52,199,89,.2);color:#34c759;border:3px solid #34c759}
.score-ok{background:rgba(240,173,78,.2);color:#f0ad4e;border:3px solid #f0ad4e}
.score-bad{background:rgba(217,83,79,.2);color:#d9534f;border:3px solid #d9534f}
.score-circle .pct{font-size:.4em;font-weight:400}
.review-item{background:#141929;border-radius:12px;padding:14px;margin-bottom:10px}
.review-item .q{font-weight:500;margin-bottom:6px;font-size:.95em}
.review-item .your-ans{font-size:.85em;margin-bottom:4px}
.review-item .correct-ans{font-size:.85em;color:#34c759}
.review-item .wrong{color:#d9534f}
.tag{display:inline-block;padding:3px 8px;border-radius:6px;font-size:.7em;font-weight:600;margin-right:4px}
.tag-easy{background:rgba(52,199,89,.2);color:#34c759}
.tag-medium{background:rgba(240,173,78,.2);color:#f0ad4e}
.tag-hard{background:rgba(217,83,79,.2);color:#d9534f}
.tag-proto{background:rgba(74,158,255,.2);color:#4a9eff}
.category-header{color:#8b92a8;font-size:.8em;font-weight:600;text-transform:uppercase;margin:16px 0 8px;letter-spacing:.5px}
.scenario-item{display:flex;justify-content:space-between;align-items:center}
.scenario-item .title{font-weight:500;font-size:.95em}
.scenario-item .tags{margin-top:4px}
.hidden{display:none!important}
.fade-in{animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.back-btn{background:none;border:none;color:#8b92a8;font-size:.9em;cursor:pointer;padding:8px 0;display:flex;align-items:center;gap:4px}
.back-btn:before{content:'←'}
.phase-label{display:inline-block;background:rgba(217,83,79,.2);color:#d9534f;padding:4px 10px;border-radius:6px;font-size:.75em;font-weight:600;margin-bottom:12px;text-transform:uppercase}
</style>
</head>
<body>
<div class="container" id="app"></div>

<script>
const SCENARIOS = [
// ── MEDICAL ──
{id:"med-acs-01",title:"Crushing Chest Pain",category:"Medical",difficulty:"Medium",
dispatch:"Respond to a restaurant for a 62-year-old male with chest pain.",
patient:{age:62,sex:"M",cc:"Crushing chest pain"},
scene:"Restaurant. Patient seated, diaphoretic, clutching his chest. Patron called 911.",
vitals:{hr:96,bp:"164/98",rr:22,spo2:94,gcs:15,temp:"98.6°F",bg:"142 mg/dL"},
history:{pmh:"HTN, hyperlipidemia, former smoker",meds:"Lisinopril, atorvastatin",allergies:"NKDA"},
presentation:"Diaphoretic male with substernal crushing chest pain radiating to left arm. Onset 20 minutes ago. Pain 8/10. Mild dyspnea.",
primary_protocol:"03.02",related_protocols:["01.01"],level_min:"E",
questions:[
 {phase:"assessment",prompt:"What is your primary clinical impression?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Acute Coronary Syndrome based on presentation and risk factor profile",correct:true,explanation:"Classic ACS presentation: substernal chest pain with radiation, diaphoresis, dyspnea, and significant cardiac risk factors (HTN, hyperlipidemia, former smoker, age/sex).",protocol_ref:"03.02"},
   {text:"Pulmonary embolism given the acute dyspnea and tachycardia",correct:false,explanation:"While PE can cause chest pain and dyspnea, the crushing substernal quality with left arm radiation is more classic for ACS. PE typically presents with pleuritic pain.",protocol_ref:"03.02"},
   {text:"Esophageal spasm secondary to recent food ingestion at the restaurant",correct:false,explanation:"Esophageal spasm can mimic cardiac pain, but with these risk factors and classic presentation, ACS must be the working impression.",protocol_ref:"03.02"},
   {text:"Hypertensive emergency given the BP of 164/98 with chest pain",correct:false,explanation:"While BP is elevated, the presentation is most consistent with ACS. The hypertension is likely a sympathetic response to pain and ischemia, not the primary problem.",protocol_ref:"03.02"}
  ]},
 {phase:"treatment",prompt:"What is your initial treatment for this patient?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Aspirin 324mg PO chewed and assist with prescribed nitroglycerin if SBP ≥ 100",correct:true,explanation:"Per Protocol 03.02: Aspirin 81mg x4 orally (chewed) unless allergic. For patients prescribed nitroglycerin with SBP ≥ 100, administer 0.3/0.4mg SL.",protocol_ref:"03.02"},
   {text:"Establish IV access and administer morphine 4mg IV for pain management first",correct:false,explanation:"Morphine is not first-line for ACS. Aspirin is the critical early intervention and should not be delayed for IV access or pain medication.",protocol_ref:"03.02"},
   {text:"Administer nitroglycerin 0.4mg SL first, then aspirin 162mg PO if pain persists",correct:false,explanation:"Aspirin dose is 324mg (4x81mg), not 162mg. Aspirin should be given regardless of pain response, and simultaneously with nitro, not sequentially.",protocol_ref:"03.02"},
   {text:"Apply high-flow O2 via NRB at 15 LPM, obtain 12-lead ECG, and defer medications to the ED",correct:false,explanation:"While oxygen and ECG are important, aspirin should not be delayed. Prehospital aspirin administration improves outcomes in ACS.",protocol_ref:"03.02"}
  ]},
 {phase:"treatment",prompt:"A 12-lead ECG shows ST elevation in leads II, III, and aVF. What is your next action?",multi_select:false,level_filter:"ACP",
  options:[
   {text:"Transmit ECG to medical control, activate CODE STEMI, and limit scene time to 10 minutes or less",correct:true,explanation:"Per Protocol 03.02: If ECG suggestive of STEMI — limit scene time ≤ 10 min, triage to nearest PCI capable facility, provide immediate CODE STEMI notification.",protocol_ref:"03.02"},
   {text:"Obtain a repeat 12-lead in 15 minutes to confirm ST changes before activating any alerts",correct:false,explanation:"Do not delay STEMI activation for serial ECGs. Time is myocardium — immediate notification is critical for PCI door-to-balloon times.",protocol_ref:"03.02"},
   {text:"Administer nitroglycerin 0.4mg SL and reassess ECG to see if ST changes resolve first",correct:false,explanation:"Nitro may be given per protocol but should not delay STEMI activation. ST elevation requires immediate CODE STEMI notification regardless of nitro response.",protocol_ref:"03.02"},
   {text:"Transport to the nearest emergency department and let them interpret the ECG on arrival",correct:false,explanation:"STEMI patients should be triaged to a PCI-capable facility with pre-arrival notification, not just the closest ED.",protocol_ref:"03.02"}
  ]},
 {phase:"transport",prompt:"Where should this STEMI patient be transported?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Nearest PCI-capable facility with CODE STEMI pre-arrival notification activated",correct:true,explanation:"Per Protocol 03.02: STEMI patients are triaged to the nearest PCI-capable facility with pre-notification.",protocol_ref:"03.02"},
   {text:"Nearest emergency department for stabilization, then arrange interfacility transfer to PCI center",correct:false,explanation:"Direct transport to PCI-capable facility is preferred. Stopping at a non-PCI hospital delays reperfusion and worsens outcomes.",protocol_ref:"03.02"},
   {text:"Nearest community hospital since the inferior STEMI is lower risk than anterior STEMI",correct:false,explanation:"All STEMI patients require PCI-capable facilities regardless of which wall is involved. Inferior STEMIs can still be life-threatening.",protocol_ref:"03.02"},
   {text:"Closest facility with a cardiac catheterization lab, even if not a designated STEMI center",correct:false,explanation:"Transport should be to a designated PCI-capable STEMI receiving center with activated CODE STEMI, not just any hospital with a cath lab.",protocol_ref:"03.02"}
  ]}
]},

{id:"med-stroke-01",title:"Sudden Facial Droop",category:"Medical",difficulty:"Medium",
dispatch:"Respond to a home for a 71-year-old female with slurred speech.",
patient:{age:71,sex:"F",cc:"Slurred speech, facial droop"},
scene:"Living room. Patient seated in recliner, right-sided facial droop, unable to lift right arm.",
vitals:{hr:88,bp:"178/96",rr:16,spo2:97,gcs:13,temp:"98.2°F",bg:"118 mg/dL"},
history:{pmh:"Atrial fibrillation, HTN, diabetes",meds:"Warfarin, metformin, metoprolol",allergies:"Sulfa"},
presentation:"Right-sided facial droop, right arm weakness, slurred speech. Symptoms noticed by husband 25 minutes ago. Last known well 45 minutes ago.",
primary_protocol:"02.12",related_protocols:["01.01"],level_min:"E",
questions:[
 {phase:"assessment",prompt:"Based on your assessment, what is your primary impression?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Acute stroke with positive Cincinnati Stroke Scale and identifiable last known well time",correct:true,explanation:"Sudden onset unilateral facial droop, arm weakness, and speech difficulty are hallmark stroke symptoms. Cincinnati Stroke Scale is positive for all three elements.",protocol_ref:"02.12"},
   {text:"Bell's palsy given the acute onset of unilateral facial droop and speech difficulty",correct:false,explanation:"Bell's palsy affects the entire side of the face (upper and lower) and does not cause arm weakness or slurred speech. This presentation is stroke until proven otherwise.",protocol_ref:"02.12"},
   {text:"Hypoglycemic episode secondary to her diabetes and metformin use",correct:false,explanation:"Blood glucose is 118 mg/dL — normal. While hypoglycemia can mimic stroke, it is ruled out by the normal glucose reading.",protocol_ref:"02.12"},
   {text:"Transient ischemic attack since symptoms started only 25 minutes ago",correct:false,explanation:"TIA cannot be distinguished from stroke in the field. All suspected stroke patients must be treated as acute stroke and transported emergently.",protocol_ref:"02.12"}
  ]},
 {phase:"treatment",prompt:"What is critical to document for this patient?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Last known well time, stroke scale findings, blood glucose, and anticoagulant use",correct:true,explanation:"Per Protocol 02.12: Establish and document last known well time, perform stroke assessment, blood glucose, and note anticoagulant use — all critical for hospital tPA/thrombectomy decisions.",protocol_ref:"02.12"},
   {text:"Symptom onset time, detailed neurological exam, GCS trend, and pupil reactivity",correct:false,explanation:"While some of these are useful, the LAST KNOWN WELL time (not onset time) is what determines tPA eligibility. Anticoagulant use (Warfarin) is critical for treatment decisions.",protocol_ref:"02.12"},
   {text:"Time of 911 call, EMS arrival time, complete medication list, and family history of stroke",correct:false,explanation:"EMS times are automatically documented. Last known well time and anticoagulant use are far more important for treatment decisions than family history.",protocol_ref:"02.12"},
   {text:"Blood pressure trend every 5 minutes, oxygen saturation, ECG rhythm, and temperature",correct:false,explanation:"While vitals are important, the critical stroke-specific documentation is LKW time, stroke scale, glucose, and anticoagulant use.",protocol_ref:"02.12"}
  ]},
 {phase:"transport",prompt:"Where should this patient be transported?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Nearest certified stroke center with pre-arrival stroke alert notification",correct:true,explanation:"Per Protocol 02.12: Transport to nearest appropriate stroke center. Pre-notify the receiving facility for stroke team activation.",protocol_ref:"02.12"},
   {text:"Nearest emergency department for CT scan, then transfer to stroke center if confirmed",correct:false,explanation:"Direct transport to a stroke center avoids delays from interfacility transfers. Time lost is brain lost.",protocol_ref:"02.12"},
   {text:"Comprehensive stroke center even if farther, since she is on Warfarin and may need reversal",correct:false,explanation:"Transport to the nearest appropriate stroke center. Warfarin reversal can be initiated at primary stroke centers as well.",protocol_ref:"02.12"},
   {text:"Closest facility since the 4.5-hour tPA window gives plenty of time for transfer",correct:false,explanation:"Every minute counts in stroke. Direct transport to a stroke center eliminates transfer delays and improves outcomes.",protocol_ref:"02.12"}
  ]}
]},

{id:"med-allergy-01",title:"Severe Allergic Reaction",category:"Medical",difficulty:"Easy",
dispatch:"Respond to a park for a 34-year-old female with difficulty breathing after a bee sting.",
patient:{age:34,sex:"F",cc:"Difficulty breathing, bee sting"},
scene:"City park. Patient standing, visibly distressed, hives on arms and neck, audible wheezing.",
vitals:{hr:118,bp:"88/54",rr:28,spo2:91,gcs:15,temp:"98.4°F"},
history:{pmh:"Bee sting allergy (carries EpiPen)",meds:"None daily",allergies:"Bee venom"},
presentation:"Diffuse urticaria, angioedema of lips, audible wheezing, tachycardic, hypotensive. Stung on right hand 10 minutes ago. Has EpiPen but hasn't used it.",
primary_protocol:"02.04A",related_protocols:["01.01","02.20A"],level_min:"E",
questions:[
 {phase:"assessment",prompt:"What severity classification does this patient meet?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Severe anaphylaxis with multi-system involvement including cardiovascular compromise",correct:true,explanation:"Per Protocol 02.04A: Severe = skin symptoms + respiratory (wheezing, dyspnea, hypoxia) WITH hypotension and poor perfusion. This patient has skin, respiratory, AND cardiovascular involvement.",protocol_ref:"02.04A"},
   {text:"Moderate allergic reaction with respiratory involvement but adequate perfusion",correct:false,explanation:"BP is 88/54 — this patient is hypotensive with cardiovascular compromise, not just respiratory involvement. This is severe, not moderate.",protocol_ref:"02.04A"},
   {text:"Severe allergic reaction limited to skin and respiratory systems only",correct:false,explanation:"This patient also has cardiovascular compromise (BP 88/54, HR 118). All three systems are involved, making this anaphylaxis with shock.",protocol_ref:"02.04A"},
   {text:"Mild anaphylaxis since the patient is still conscious and alert with a GCS of 15",correct:false,explanation:"Severity is determined by system involvement and hemodynamic status, not mental status alone. Hypotension and wheezing make this severe.",protocol_ref:"02.04A"}
  ]},
 {phase:"treatment",prompt:"What is your immediate intervention?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Epinephrine 0.3mg IM via auto-injector, then reassess and support ABCs",correct:true,explanation:"Per Protocol 02.04A: For severe allergic reaction/anaphylaxis, epinephrine is the first-line treatment. 0.3mg IM via auto-injector preferred.",protocol_ref:"02.04A"},
   {text:"Diphenhydramine 50mg IM and albuterol nebulizer to address the histamine response",correct:false,explanation:"Epinephrine is FIRST-LINE for anaphylaxis. Antihistamines are secondary adjuncts and do not treat bronchospasm or cardiovascular collapse.",protocol_ref:"02.04A"},
   {text:"Assist with the patient's own EpiPen and start albuterol nebulizer simultaneously",correct:false,explanation:"Do not wait for the patient to self-administer. EMTs should administer epinephrine immediately. The patient's EpiPen can be used but EMS should take the lead.",protocol_ref:"02.04A"},
   {text:"IV normal saline bolus 20mL/kg for the hypotension, then epinephrine if BP doesn't improve",correct:false,explanation:"Epinephrine is the first-line treatment and should not be delayed for fluid resuscitation. Epinephrine addresses the underlying pathophysiology.",protocol_ref:"02.04A"}
  ]},
 {phase:"transport",prompt:"The patient's symptoms improve after epinephrine. What is your transport decision?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Transport to hospital for monitoring given the risk of biphasic anaphylactic reaction",correct:true,explanation:"All anaphylaxis patients require hospital evaluation and monitoring for biphasic reaction (can occur 1-72 hours later), even if symptoms improve.",protocol_ref:"02.04A"},
   {text:"Monitor on scene for 20 minutes, then transport only if symptoms return",correct:false,explanation:"Biphasic reactions can occur hours later. Transport should not be delayed for on-scene monitoring. Monitor en route.",protocol_ref:"02.04A"},
   {text:"Transport is optional since epinephrine resolved the reaction completely",correct:false,explanation:"Even with complete symptom resolution, biphasic reactions can be life-threatening. All anaphylaxis patients need ED evaluation.",protocol_ref:"02.04A"},
   {text:"Administer a second dose of epinephrine prophylactically and then allow patient to refuse",correct:false,explanation:"A second dose is only given if symptoms recur. Prophylactic dosing is not indicated. All anaphylaxis patients should be strongly encouraged to go to the ED.",protocol_ref:"02.04A"}
  ]}
]},

{id:"med-seizure-01",title:"Active Seizure",category:"Medical",difficulty:"Easy",
dispatch:"Respond to an office building for a 28-year-old male having a seizure.",
patient:{age:28,sex:"M",cc:"Seizure activity"},
scene:"Office break room. Patient on floor, tonic-clonic activity. Coworkers holding him down.",
vitals:{hr:112,bp:"156/92",rr:8,spo2:86,gcs:3,temp:"99.8°F",bg:"94 mg/dL"},
history:{pmh:"Epilepsy",meds:"Levetiracetam (Keppra)",allergies:"NKDA"},
presentation:"Active generalized tonic-clonic seizure. Coworkers state it started approximately 3 minutes ago. Cyanotic around lips.",
primary_protocol:"02.19A",related_protocols:["01.01","05.01A"],level_min:"E",
questions:[
 {phase:"scene",prompt:"Coworkers are holding the patient down. What is your first action?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Direct bystanders to release the patient, clear hazards, and protect from injury without restraint",correct:true,explanation:"Per Protocol 02.19A: Do not restrain. Protect from injury by clearing the area. Never place anything in the patient's mouth during a seizure.",protocol_ref:"02.19A"},
   {text:"Assist bystanders in firmly holding the patient's extremities to prevent musculoskeletal injury",correct:false,explanation:"Restraining a seizing patient can cause fractures, dislocations, and soft tissue injury. Protect by clearing the environment, not by holding down.",protocol_ref:"02.19A"},
   {text:"Insert a nasal airway and position the patient on their side while bystanders stabilize the head",correct:false,explanation:"During active tonic-clonic seizure, do not attempt to insert anything. The priority is to stop restraint, clear hazards, and protect from injury.",protocol_ref:"02.19A"},
   {text:"Immediately suction the airway and apply high-flow oxygen via NRB while bystanders maintain position",correct:false,explanation:"During active seizure, suctioning and NRB placement are not practical. First priority is stopping the restraint and protecting from injury.",protocol_ref:"02.19A"}
  ]},
 {phase:"treatment",prompt:"The seizure continues for 5+ minutes. What medication intervention is indicated?",multi_select:false,level_filter:"CP",
  options:[
   {text:"Midazolam 5mg IM or IN as first-line benzodiazepine for status epilepticus",correct:true,explanation:"Per Protocol 02.19A: For prolonged seizure activity (>5 min), midazolam is the first-line benzodiazepine. IM or IN routes preferred when IV not available.",protocol_ref:"02.19A"},
   {text:"Diazepam 5mg IV push, or 10mg rectal if no IV access is available",correct:false,explanation:"While diazepam is a benzodiazepine, midazolam IM/IN is the preferred first-line agent per RI protocol due to faster onset via non-IV routes.",protocol_ref:"02.19A"},
   {text:"Lorazepam 2mg slow IV push over 2 minutes with cardiac monitoring",correct:false,explanation:"Midazolam IM/IN is the preferred first-line agent per RI protocol. Lorazepam requires IV access which may be difficult during active seizure.",protocol_ref:"02.19A"},
   {text:"Levetiracetam 1000mg IV since the patient is already prescribed Keppra as maintenance therapy",correct:false,explanation:"Levetiracetam is not a prehospital medication in RI protocols. Benzodiazepines (midazolam) are the first-line prehospital treatment for status epilepticus.",protocol_ref:"02.19A"}
  ]}
]},

{id:"med-resp-01",title:"Asthma Exacerbation",category:"Medical",difficulty:"Easy",
dispatch:"Respond to a school for a 16-year-old with difficulty breathing.",
patient:{age:16,sex:"F",cc:"Can't breathe, asthma attack"},
scene:"School nurse's office. Patient sitting upright, using accessory muscles, audible wheezing.",
vitals:{hr:124,bp:"130/80",rr:30,spo2:89,gcs:15,temp:"98.6°F"},
history:{pmh:"Asthma, uses rescue inhaler",meds:"Albuterol MDI (own)",allergies:"NKDA"},
presentation:"Severe respiratory distress. Tripod positioning. Diffuse bilateral wheezing. Speaking in 2-3 word sentences. Already used her inhaler twice with no relief.",
primary_protocol:"02.08A",related_protocols:["01.01","05.01A"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"The patient has already used her inhaler twice. What is your treatment?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Albuterol 2.5mg via nebulizer with ipratropium bromide 500mcg and supplemental oxygen",correct:true,explanation:"Per Protocol 02.08A: Albuterol via nebulizer with ipratropium bromide for severe respiratory distress. Nebulized delivery is more effective than MDI in severe cases.",protocol_ref:"02.08A"},
   {text:"Assist with two additional puffs of her prescribed albuterol MDI via spacer with oxygen by NC",correct:false,explanation:"EMS-administered nebulized albuterol provides better drug delivery in severe distress. Also, ipratropium should be added per protocol for severe cases.",protocol_ref:"02.08A"},
   {text:"Albuterol 2.5mg via nebulizer only, and reserve ipratropium for ALS if she doesn't improve",correct:false,explanation:"Per protocol, ipratropium bromide should be combined with albuterol for severe respiratory distress, not withheld as a second-line agent.",protocol_ref:"02.08A"},
   {text:"High-flow oxygen via NRB at 15 LPM and coach pursed-lip breathing during rapid transport",correct:false,explanation:"While oxygen is indicated, bronchodilator therapy is the primary treatment for bronchospasm and should not be withheld in favor of oxygen alone.",protocol_ref:"02.08A"}
  ]},
 {phase:"treatment",prompt:"Despite nebulizer treatment, the patient is worsening with SpO2 of 85%. What do you consider?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Epinephrine 0.3mg IM and initiate CPAP if available at 5-10 cmH2O",correct:true,explanation:"Per Protocol 02.08A: Epinephrine IM for severe bronchospasm not responding to nebulized albuterol. CPAP/BiPAP if available and not contraindicated.",protocol_ref:"02.08A"},
   {text:"Repeat albuterol 2.5mg and ipratropium 500mcg via nebulizer and reassess in 10 minutes",correct:false,explanation:"Worsening despite initial nebulizer requires escalation to epinephrine, not just repeating the same treatment that failed.",protocol_ref:"02.08A"},
   {text:"Prepare for endotracheal intubation with RSI medications and BVM ventilation",correct:false,explanation:"Intubation is a last resort in severe asthma. Epinephrine and CPAP should be attempted first before invasive airway management.",protocol_ref:"02.08A"},
   {text:"Magnesium sulfate 2g IV over 20 minutes as a bronchodilator adjunct with continued nebulizer",correct:false,explanation:"While magnesium may be used in some protocols, epinephrine IM is the next escalation step per RI protocol for refractory bronchospasm.",protocol_ref:"02.08A"}
  ]}
]},

// ── CARDIAC ──
{id:"card-arrest-01",title:"Witnessed Cardiac Arrest",category:"Cardiac",difficulty:"Hard",
dispatch:"Respond to a gym for an unresponsive male, bystander CPR in progress.",
patient:{age:55,sex:"M",cc:"Unresponsive, not breathing"},
scene:"Gym floor. Bystander performing CPR. Gym's AED is nearby but not yet applied.",
vitals:{hr:0,bp:"N/A",rr:0,spo2:"N/A",gcs:3},
history:{pmh:"Unknown",meds:"Unknown",allergies:"Unknown"},
presentation:"Unresponsive, apneic, pulseless. Bystander reports witnessed collapse approximately 4 minutes ago. Good quality bystander CPR ongoing.",
primary_protocol:"03.03A",related_protocols:["01.01"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"Bystander CPR is in progress. What is your immediate priority?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Apply AED pads and analyze rhythm immediately while minimizing interruption to compressions",correct:true,explanation:"Per Protocol 03.03A: A defibrillator should be applied as soon as available and ECG rhythm analysis should immediately follow. Minimize interruptions in compressions.",protocol_ref:"03.03A"},
   {text:"Take over CPR from bystander first, then establish IV access before applying the AED",correct:false,explanation:"The AED/defibrillator should be applied immediately. IV access is important but defibrillation takes priority in witnessed VF arrest.",protocol_ref:"03.03A"},
   {text:"Insert an OPA and begin BVM ventilations before applying the AED to address hypoxia",correct:false,explanation:"In a witnessed adult arrest, early defibrillation takes priority over advanced airway management. Apply the AED first.",protocol_ref:"03.03A"},
   {text:"Confirm pulselessness with a 10-second pulse check and assess rhythm on the monitor first",correct:false,explanation:"Bystander CPR is already in progress confirming pulselessness. Apply the AED immediately — do not delay for additional assessment.",protocol_ref:"03.03A"}
  ]},
 {phase:"treatment",prompt:"The AED analyzes ventricular fibrillation. What do you do?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Deliver one shock, immediately resume CPR for 2 minutes, then reanalyze the rhythm",correct:true,explanation:"Per Protocol 03.03A and AHA guidelines: Deliver single shock, immediately resume CPR for 2 minutes, then reanalyze. Minimize interruptions.",protocol_ref:"03.03A"},
   {text:"Deliver three rapid stacked shocks, then check pulse and resume CPR if no ROSC",correct:false,explanation:"Stacked shocks are no longer recommended. Current guidelines call for single shock followed by immediate 2-minute CPR cycle.",protocol_ref:"03.03A"},
   {text:"Deliver one shock, then immediately check for a pulse before resuming compressions",correct:false,explanation:"Do not pause for a pulse check after the shock. Resume CPR immediately for 2 full minutes before reassessing rhythm.",protocol_ref:"03.03A"},
   {text:"Perform 2 minutes of CPR first to circulate oxygenated blood, then deliver the shock",correct:false,explanation:"For witnessed VF arrest with bystander CPR already in progress, immediate defibrillation is recommended without delay.",protocol_ref:"03.03A"}
  ]},
 {phase:"treatment",prompt:"After 2 rounds of CPR and defibrillation, what additional interventions should be performed?",multi_select:false,level_filter:"CP",
  options:[
   {text:"Establish IV/IO access, administer epinephrine 1mg, and consider advanced airway placement",correct:true,explanation:"Per Protocol 03.03A: After initial CPR and defibrillation, establish vascular access and administer epinephrine. Consider advanced airway without interrupting compressions.",protocol_ref:"03.03A"},
   {text:"Administer amiodarone 300mg IV/IO first as the antiarrhythmic for refractory VF",correct:false,explanation:"Epinephrine is administered first. Amiodarone is considered for VF/pVT refractory to defibrillation AND epinephrine.",protocol_ref:"03.03A"},
   {text:"Establish IV access and administer sodium bicarbonate 1mEq/kg to correct metabolic acidosis",correct:false,explanation:"Sodium bicarbonate is not routinely given in cardiac arrest. Epinephrine is the first-line vasopressor per protocol.",protocol_ref:"03.03A"},
   {text:"Place an advanced airway first to ensure adequate oxygenation before any medications",correct:false,explanation:"Vascular access and epinephrine take priority. Advanced airway is considered but should not delay medication administration or interrupt compressions.",protocol_ref:"03.03A"}
  ]}
]},

{id:"card-brady-01",title:"Symptomatic Bradycardia",category:"Cardiac",difficulty:"Medium",
dispatch:"Respond to a residence for a 78-year-old female feeling dizzy and weak.",
patient:{age:78,sex:"F",cc:"Dizziness, weakness"},
scene:"Bedroom. Patient lying in bed, pale, diaphoretic.",
vitals:{hr:36,bp:"76/48",rr:18,spo2:94,gcs:14,temp:"97.8°F",bg:"102 mg/dL"},
history:{pmh:"HTN, heart block",meds:"Metoprolol, lisinopril",allergies:"Penicillin"},
presentation:"Pale, diaphoretic female with severe bradycardia at 36 bpm. Altered mentation — oriented to person only. Hypotensive.",
primary_protocol:"03.05A",related_protocols:["01.01"],level_min:"E",
questions:[
 {phase:"assessment",prompt:"What makes this bradycardia symptomatic and requiring treatment?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"The rate of 36 is causing hypotension, altered mental status, and signs of poor perfusion",correct:true,explanation:"Symptomatic bradycardia = slow rate PLUS hemodynamic compromise: hypotension, altered mental status, signs of poor perfusion (diaphoresis, pallor).",protocol_ref:"03.05A"},
   {text:"The heart rate is below 60 bpm which meets the threshold for treatment regardless of symptoms",correct:false,explanation:"Bradycardia alone doesn't require treatment. It must be symptomatic with hemodynamic compromise to warrant intervention.",protocol_ref:"03.05A"},
   {text:"The hypotension and altered mental status are the concern but are likely from sepsis, not the rate",correct:false,explanation:"The bradycardia is the most likely cause of the hemodynamic compromise. The rate of 36 is insufficient to maintain adequate cardiac output.",protocol_ref:"03.05A"},
   {text:"The metoprolol overdose is causing beta-blocker toxicity requiring specific antidote therapy",correct:false,explanation:"While metoprolol can contribute to bradycardia, there is no evidence of overdose. The clinical picture is symptomatic bradycardia requiring standard treatment per protocol.",protocol_ref:"03.05A"}
  ]},
 {phase:"treatment",prompt:"What is the paramedic treatment for this patient?",multi_select:false,level_filter:"P",
  options:[
   {text:"Atropine 0.5mg IV, may repeat every 3-5 minutes; prepare for transcutaneous pacing if ineffective",correct:true,explanation:"Per Protocol 03.05A: Atropine is first-line for symptomatic bradycardia. Transcutaneous pacing is indicated if atropine is ineffective.",protocol_ref:"03.05A"},
   {text:"Initiate transcutaneous pacing at 60 bpm immediately as first-line treatment for this rate",correct:false,explanation:"Atropine is the first-line treatment for symptomatic bradycardia. Pacing is reserved for cases refractory to atropine.",protocol_ref:"03.05A"},
   {text:"Epinephrine 0.1mg IV push (1:10,000) titrated to heart rate response every 2 minutes",correct:false,explanation:"Atropine is the first-line agent. Low-dose epinephrine infusion may be considered but is not the initial treatment per protocol.",protocol_ref:"03.05A"},
   {text:"Dopamine infusion at 5mcg/kg/min to increase heart rate and blood pressure simultaneously",correct:false,explanation:"Dopamine infusion may be considered for refractory cases, but atropine is the first-line treatment per protocol for symptomatic bradycardia.",protocol_ref:"03.05A"}
  ]}
]},

// ── TRAUMA ──
{id:"trauma-mva-01",title:"High-Speed MVC",category:"Trauma",difficulty:"Hard",
dispatch:"Respond to highway for a 2-vehicle MVC with entrapment.",
patient:{age:42,sex:"M",cc:"MVC with entrapment"},
scene:"Highway. Significant front-end damage, deployed airbags. Driver trapped by dashboard. Conscious and screaming in pain.",
vitals:{hr:128,bp:"86/58",rr:26,spo2:92,gcs:14,temp:"97.0°F"},
history:{pmh:"None known",meds:"Unknown",allergies:"Unknown"},
presentation:"Restrained driver, entrapped. Obvious deformity left femur. Abdominal tenderness. Tachycardic and hypotensive. Diaphoretic.",
primary_protocol:"04.01A",related_protocols:["04.03","04.04","04.05","02.21A"],level_min:"E",
questions:[
 {phase:"scene",prompt:"What are your scene management priorities?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Ensure scene safety, request fire/rescue for extrication, initiate spinal precautions and rapid trauma assessment",correct:true,explanation:"Per Protocol 04.01A: Scene safety first, request extrication resources, apply spinal precautions per protocol, perform rapid trauma assessment.",protocol_ref:"04.01A"},
   {text:"Begin patient assessment through the vehicle window, start IV access, and request ALS intercept",correct:false,explanation:"While assessment can begin through the window, the priority is scene safety and requesting extrication resources. IV access can wait until the patient is accessible.",protocol_ref:"04.01A"},
   {text:"Stabilize the vehicle, assist fire with manual extrication, and apply a cervical collar immediately",correct:false,explanation:"EMS should not perform extrication — that requires specialized equipment and trained rescue personnel. Focus on scene safety and patient assessment.",protocol_ref:"04.01A"},
   {text:"Perform a focused assessment of the femur deformity and apply a traction splint while entrapped",correct:false,explanation:"Multi-trauma requires a systematic approach. Scene safety and extrication resources are the priority, not focused treatment of a single injury while entrapped.",protocol_ref:"04.01A"}
  ]},
 {phase:"treatment",prompt:"The patient is extricated. He's tachycardic at 128 and hypotensive at 86/58 with a deformed left femur. What do you prioritize?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Hemorrhage control, traction splint to the femur, IV fluid resuscitation, and rapid transport",correct:true,explanation:"Per Protocols 04.01A/02.21A: Hemorrhage control is priority. Traction splint for femur fracture (controls internal bleeding). IV fluids for hemorrhagic shock. Rapid transport to trauma center.",protocol_ref:"04.01A"},
   {text:"Full spinal immobilization on a long board, complete secondary survey, then splint all injuries",correct:false,explanation:"Critical trauma patients with signs of shock get a rapid assessment and rapid transport. Detailed secondary survey is performed en route, not on scene.",protocol_ref:"04.01A"},
   {text:"Two large-bore IVs with aggressive fluid resuscitation to normalize BP before moving the patient",correct:false,explanation:"While IV access is important, do not delay transport to normalize vital signs. Hemorrhagic shock requires surgical intervention at a trauma center.",protocol_ref:"04.01A"},
   {text:"Pain management with fentanyl IV, then splint the femur and perform a thorough head-to-toe exam",correct:false,explanation:"Pain management should not delay hemorrhage control and rapid transport. The priority is addressing life threats and getting to a trauma center.",protocol_ref:"04.01A"}
  ]},
 {phase:"transport",prompt:"Where should this patient be transported?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Highest level trauma center accessible within an appropriate transport time",correct:true,explanation:"Per Protocol 04.01A: Multi-trauma with hemodynamic instability meets trauma center criteria. Transport to highest level trauma center available.",protocol_ref:"04.01A"},
   {text:"Nearest emergency department for initial stabilization and IV blood products, then arrange transfer",correct:false,explanation:"Direct transport to a trauma center is preferred. Stopping at a non-trauma hospital delays definitive surgical care.",protocol_ref:"04.01A"},
   {text:"Nearest Level 3 trauma center since it can handle the femur fracture and fluid resuscitation",correct:false,explanation:"This multi-system trauma patient with hemorrhagic shock needs the highest level of trauma care available, not just orthopedic capability.",protocol_ref:"04.01A"},
   {text:"Closest hospital by ground, then request helicopter transfer to the trauma center",correct:false,explanation:"Direct ground transport to a trauma center is preferred over a two-step process that delays definitive care.",protocol_ref:"04.01A"}
  ]}
]},

{id:"trauma-burn-01",title:"Kitchen Burn Injury",category:"Trauma",difficulty:"Medium",
dispatch:"Respond to a residence for a burn injury.",
patient:{age:45,sex:"F",cc:"Burns to arms and chest"},
scene:"Kitchen. Grease fire on stove (extinguished). Patient with burns to both arms and anterior chest.",
vitals:{hr:108,bp:"138/82",rr:22,spo2:96,gcs:15,temp:"98.6°F"},
history:{pmh:"None",meds:"None",allergies:"NKDA"},
presentation:"Partial and full-thickness burns to bilateral forearms (circumferential) and anterior chest. Estimated 18% BSA. No facial burns, no soot in airway, voice normal.",
primary_protocol:"04.07A",related_protocols:["01.01","02.07A"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"What is your burn management for this patient?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Remove clothing and jewelry, apply dry sterile dressings, manage pain, and initiate IV fluid resuscitation",correct:true,explanation:"Per Protocol 04.07A: Remove clothing and jewelry, cover with dry sterile dressings, pain management, IV fluids for burns >15% BSA.",protocol_ref:"04.07A"},
   {text:"Apply cool wet dressings soaked in sterile saline to all burned areas and wrap with cling film",correct:false,explanation:"Wet dressings on large burns (18% BSA) promote hypothermia. Dry sterile dressings are indicated for burns of this size.",protocol_ref:"04.07A"},
   {text:"Apply topical silver sulfadiazine cream to partial-thickness areas, then cover with sterile gauze",correct:false,explanation:"Do not apply ointments or creams in the prehospital setting. Cover with dry sterile dressings only.",protocol_ref:"04.07A"},
   {text:"Irrigate burn areas with cool running water for 20 minutes, then cover with moist sterile dressings",correct:false,explanation:"Prolonged irrigation of large BSA burns risks hypothermia. For burns >15% BSA, use dry sterile dressings and prioritize fluid resuscitation and transport.",protocol_ref:"04.07A"}
  ]},
 {phase:"transport",prompt:"This patient has 18% BSA burns with circumferential forearm burns. Where should she be transported?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Designated burn center, as this meets referral criteria for BSA percentage and circumferential burns",correct:true,explanation:"Per Protocol 04.07A: Burns >10% BSA and circumferential burns meet burn center referral criteria.",protocol_ref:"04.07A"},
   {text:"Nearest emergency department for initial wound care and pain management, then arrange burn center transfer",correct:false,explanation:"Direct transport to a burn center is preferred when accessible, avoiding delays from interfacility transfer.",protocol_ref:"04.07A"},
   {text:"Nearest trauma center since the burn percentage is below the 20% threshold for burn center referral",correct:false,explanation:"The threshold for burn center referral is >10% BSA, not 20%. Additionally, circumferential burns independently meet referral criteria.",protocol_ref:"04.07A"},
   {text:"Nearest ED since there are no airway burns and the patient is hemodynamically stable",correct:false,explanation:"Burn center referral criteria include >10% BSA and circumferential extremity burns, regardless of airway involvement or hemodynamic status.",protocol_ref:"04.07A"}
  ]}
]},

// ── PEDIATRIC ──
{id:"peds-resp-01",title:"Pediatric Respiratory Distress",category:"Pediatric",difficulty:"Medium",
dispatch:"Respond to a daycare for a 3-year-old with difficulty breathing.",
patient:{age:3,sex:"M",cc:"Difficulty breathing, wheezing"},
scene:"Daycare. Child sitting in teacher's lap, retracting, audible wheezing. Teacher reports known asthmatic.",
vitals:{hr:140,bp:"90/60",rr:40,spo2:88,gcs:15,temp:"99.2°F"},
history:{pmh:"Asthma",meds:"Albuterol MDI (at home, not at daycare)",allergies:"NKDA"},
presentation:"3-year-old in severe respiratory distress. Intercostal and subcostal retractions. Bilateral wheezing. Speaking only in single words. Using accessory muscles.",
primary_protocol:"02.08P",related_protocols:["01.01","05.01P"],level_min:"E",
questions:[
 {phase:"assessment",prompt:"How do you classify this child's respiratory distress?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Severe respiratory distress based on retractions, accessory muscle use, single-word speech, and SpO2 of 88%",correct:true,explanation:"Per Protocol 02.08P: Severe distress in children = poor air entry, extreme accessory muscle use, retractions, altered behavior, cyanosis and/or altered mental status.",protocol_ref:"02.08P"},
   {text:"Moderate respiratory distress since the child is still conscious, alert, and has audible wheezing",correct:false,explanation:"Consciousness and audible wheezing do not define moderate. The degree of retractions, accessory muscle use, single-word speech, and SpO2 of 88% indicate severe distress.",protocol_ref:"02.08P"},
   {text:"Mild respiratory distress with wheezing that should respond to a single nebulizer treatment",correct:false,explanation:"Intercostal/subcostal retractions, accessory muscle use, single-word speech, and SpO2 of 88% are far beyond mild classification.",protocol_ref:"02.08P"},
   {text:"Impending respiratory failure requiring immediate advanced airway management and intubation",correct:false,explanation:"While this is severe, the child is still conscious with a GCS of 15 and has audible wheezing (moving air). Bronchodilator therapy should be attempted before considering advanced airway.",protocol_ref:"02.08P"}
  ]},
 {phase:"treatment",prompt:"What is your treatment for this child?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Albuterol 2.5mg nebulizer with ipratropium 250mcg and high-flow supplemental oxygen",correct:true,explanation:"Per Protocol 02.08P: For severe pediatric respiratory distress, albuterol with ipratropium via nebulizer. Epinephrine IM if approaching respiratory failure.",protocol_ref:"02.08P"},
   {text:"Albuterol 2.5mg via nebulizer alone with blow-by oxygen, adding ipratropium only if no improvement",correct:false,explanation:"Per protocol, ipratropium should be combined with albuterol for severe respiratory distress in pediatrics, not withheld as a second-line treatment.",protocol_ref:"02.08P"},
   {text:"Albuterol 5mg via nebulizer with ipratropium 500mcg using the standard adult dosing for faster relief",correct:false,explanation:"Use pediatric dosing: albuterol 2.5mg and ipratropium 250mcg for children. Adult doses can cause significant tachycardia and tremor in a 3-year-old.",protocol_ref:"02.08P"},
   {text:"Dexamethasone 0.6mg/kg PO and albuterol MDI 4 puffs via spacer with mask, reassess in 15 minutes",correct:false,explanation:"Severe distress with SpO2 of 88% requires nebulized bronchodilators for better drug delivery, not MDI. Steroids are not a first-line prehospital intervention.",protocol_ref:"02.08P"}
  ]}
]},

{id:"peds-arrest-01",title:"Pediatric Cardiac Arrest",category:"Pediatric",difficulty:"Hard",
dispatch:"Respond to a residence for a 6-year-old not breathing.",
patient:{age:6,sex:"F",cc:"Unresponsive, not breathing"},
scene:"Bedroom. Child unresponsive in bed. Parents frantic. No bystander CPR.",
vitals:{hr:0,bp:"N/A",rr:0,spo2:"N/A",gcs:3},
history:{pmh:"Recent upper respiratory infection",meds:"None",allergies:"NKDA"},
presentation:"Unresponsive, apneic, pulseless 6-year-old. Cyanotic. Parents report she was coughing all night and they found her unresponsive this morning.",
primary_protocol:"03.03P",related_protocols:["01.01","05.01P"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"What is the critical difference in pediatric vs adult cardiac arrest management?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Pediatric arrest is most often respiratory in etiology — ventilation and oxygenation are critical from the start",correct:true,explanation:"Per Protocol 03.03P: Unlike adults, pediatric cardiac arrest is most commonly caused by respiratory failure. Early effective ventilation is essential.",protocol_ref:"03.03P"},
   {text:"No difference — treat identically to adult arrest",correct:false,explanation:"Pediatric arrest has different etiologies and treatment priorities, especially early ventilation.",protocol_ref:"03.03P"},
   {text:"Always defibrillate first in pediatric arrest",correct:false,explanation:"Most pediatric arrests are non-shockable rhythms (PEA/asystole) from respiratory causes.",protocol_ref:"03.03P"},
   {text:"Pediatric patients don't need chest compressions",correct:false,explanation:"High-quality CPR is essential. Compression depth is 1/3 AP diameter of chest.",protocol_ref:"03.03P"}
  ]},
 {phase:"treatment",prompt:"The cardiac monitor shows asystole. What are your priorities?",multi_select:false,level_filter:"CP",
  options:[
   {text:"High-quality CPR with effective ventilation, epinephrine 0.01mg/kg IV/IO, identify and treat reversible causes",correct:true,explanation:"Per Protocol 03.03P: For non-shockable rhythm, high-quality CPR, epinephrine, and identify reversible causes (Hs and Ts).",protocol_ref:"03.03P"},
   {text:"Defibrillate at 2J/kg",correct:false,explanation:"Asystole is a non-shockable rhythm. Defibrillation is not indicated.",protocol_ref:"03.03P"},
   {text:"Atropine 0.5mg IV",correct:false,explanation:"Atropine is no longer routinely recommended for pediatric cardiac arrest.",protocol_ref:"03.03P"},
   {text:"CPR only — no medications for pediatric arrest",correct:false,explanation:"Epinephrine is indicated for pediatric cardiac arrest.",protocol_ref:"03.03P"}
  ]}
]},

// ── SPECIAL ──
{id:"spec-tox-01",title:"Opioid Overdose",category:"Special",difficulty:"Easy",
dispatch:"Respond to a park restroom for an unresponsive person.",
patient:{age:29,sex:"M",cc:"Unresponsive"},
scene:"Park restroom. Patient slumped on floor. Syringe and drug paraphernalia visible nearby.",
vitals:{hr:52,bp:"90/60",rr:4,spo2:78,gcs:4,temp:"97.2°F"},
history:{pmh:"IV drug use",meds:"None",allergies:"Unknown"},
presentation:"Unresponsive male with pinpoint pupils, respiratory rate of 4, cyanotic. Track marks on bilateral arms. Drug paraphernalia on scene.",
primary_protocol:"04.18A",related_protocols:["01.01","05.01A"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"What is your immediate treatment priority?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Ventilate with BVM and administer naloxone (Narcan) — titrate to respiratory effort, not full consciousness",correct:true,explanation:"Per Protocol 04.18A: Support ventilations and administer naloxone. Goal is adequate respiratory effort, NOT full alertness — over-reversal can cause acute withdrawal and agitation.",protocol_ref:"04.18A"},
   {text:"Naloxone only — ventilation isn't needed if you give Narcan quickly",correct:false,explanation:"Ventilation is critical. Naloxone takes time to work. BVM ventilation provides immediate oxygenation.",protocol_ref:"04.18A"},
   {text:"Sternal rub to wake the patient, then transport",correct:false,explanation:"Painful stimuli won't reverse opioid toxicity. This patient needs naloxone and ventilatory support.",protocol_ref:"04.18A"},
   {text:"Start CPR immediately",correct:false,explanation:"The patient has a pulse (HR 52). CPR is not indicated. Support ventilations and administer naloxone.",protocol_ref:"04.18A"}
  ]},
 {phase:"treatment",prompt:"After naloxone, the patient becomes alert and agitated. He wants to refuse transport. What do you do?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Strongly encourage transport — naloxone has a shorter duration than most opioids, re-sedation is possible",correct:true,explanation:"Naloxone's duration (30-90 min) is shorter than most opioids. The patient may re-sedate and develop respiratory failure after naloxone wears off.",protocol_ref:"04.18A"},
   {text:"He's alert and oriented, so he can refuse — sign the refusal and leave",correct:false,explanation:"While competent patients can refuse, you must explain the risk of re-sedation. Follow the Refusal Protocol thoroughly.",protocol_ref:"06.04"},
   {text:"Restrain him and transport against his will",correct:false,explanation:"A competent patient cannot be transported against their will without specific criteria being met.",protocol_ref:"06.04"},
   {text:"The naloxone cured him — no need for hospital",correct:false,explanation:"Naloxone is temporary. The opioid will outlast the naloxone.",protocol_ref:"04.18A"}
  ]}
]},

{id:"spec-hypo-01",title:"Hypothermic Patient",category:"Special",difficulty:"Medium",
dispatch:"Respond to a park bench for a homeless person found unresponsive in cold weather.",
patient:{age:58,sex:"M",cc:"Found unresponsive in cold"},
scene:"Park bench. Temperature is 28°F. Patient on bench with minimal clothing, altered mental status.",
vitals:{hr:44,bp:"88/60",rr:10,spo2:90,gcs:10,temp:"90°F"},
history:{pmh:"Unknown, suspected alcohol use disorder",meds:"Unknown",allergies:"Unknown"},
presentation:"Altered, shivering male. Cold to touch. Bradycardic. Speech confused and slurred. Mild to moderate hypothermia.",
primary_protocol:"04.13A",related_protocols:["01.01","02.05A"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"What is the priority in managing this hypothermic patient?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Remove wet clothing, prevent further heat loss, passive and active rewarming, handle gently to avoid triggering dysrhythmias",correct:true,explanation:"Per Protocol 04.13A: Remove wet clothing, insulate, passive rewarming. Handle gently — hypothermic hearts are prone to dysrhythmias with rough handling.",protocol_ref:"04.13A"},
   {text:"Vigorously rub extremities to restore circulation",correct:false,explanation:"Vigorous rubbing can push cold blood to the core and worsen hypothermia. Handle gently.",protocol_ref:"04.13A"},
   {text:"Give hot coffee to warm internally",correct:false,explanation:"No oral fluids for altered mental status patients. Also, oral rewarming is minimally effective.",protocol_ref:"04.13A"},
   {text:"Only treat in the ambulance with the heater on",correct:false,explanation:"Begin interventions immediately — remove wet clothes and insulate before/during transport.",protocol_ref:"04.13A"}
  ]},
 {phase:"treatment",prompt:"The patient's heart rate drops to 30 and the ECG shows a Junctional rhythm. What is your approach?",multi_select:false,level_filter:"CP",
  options:[
   {text:"Continue rewarming and transport — medications and pacing may be ineffective until core temperature rises above 86°F",correct:true,explanation:"Per Protocol 04.13A: Below 86°F, the heart may not respond to atropine, pacing, or defibrillation. Focus on rewarming. Withhold repeat medication dosing until rewarmed.",protocol_ref:"04.13A"},
   {text:"Atropine 1mg IV push immediately",correct:false,explanation:"Atropine is typically ineffective in hypothermia. The bradycardia is a physiologic response to cold.",protocol_ref:"04.13A"},
   {text:"Immediate transcutaneous pacing",correct:false,explanation:"Pacing may be ineffective and can trigger VF in the hypothermic heart.",protocol_ref:"04.13A"},
   {text:"Administer warm IV fluids at maximum rate to rapidly rewarm",correct:false,explanation:"Warm IV fluids are appropriate but aggressive fluid boluses are not the primary treatment for hypothermic bradycardia.",protocol_ref:"04.13A"}
  ]}
]},

{id:"spec-ob-01",title:"Imminent Delivery",category:"Special",difficulty:"Medium",
dispatch:"Respond to a vehicle on the highway for a woman in labor.",
patient:{age:30,sex:"F",cc:"In labor, baby coming"},
scene:"Pulled over on highway shoulder. Backseat of car. Woman screaming, crowning visible.",
vitals:{hr:102,bp:"128/78",rr:24,spo2:98,gcs:15},
history:{pmh:"G3P2, 39 weeks, uncomplicated pregnancy",meds:"Prenatal vitamins",allergies:"NKDA"},
presentation:"Full-term pregnancy with crowning. Contractions every 1 minute. This is her third baby. Delivery is imminent — no time for transport.",
primary_protocol:"02.17",related_protocols:["01.01","02.16"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"Crowning is visible and contractions are 1 minute apart. What do you do?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Prepare for field delivery — support the head as it delivers, check for nuchal cord, suction mouth then nose, deliver shoulders with gentle downward then upward traction",correct:true,explanation:"Per Protocol 02.17: With crowning and frequent contractions, prepare for delivery. Support the head, check for nuchal cord, clear airway, deliver shoulders.",protocol_ref:"02.17"},
   {text:"Hold the baby's head and prevent delivery until you reach the hospital",correct:false,explanation:"Never hold back or delay delivery. An imminent delivery should proceed in the field.",protocol_ref:"02.17"},
   {text:"Rush to the hospital — there's always time",correct:false,explanation:"Crowning with 1-minute contractions means delivery is seconds to minutes away. Prepare for field delivery.",protocol_ref:"02.17"},
   {text:"Only a doctor can deliver a baby",correct:false,explanation:"EMS providers are trained to manage field deliveries. This baby is coming now.",protocol_ref:"02.17"}
  ]},
 {phase:"treatment",prompt:"The baby is delivered. She is limp, not crying, and appears cyanotic. What are your immediate actions?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Dry and stimulate vigorously, suction airway, keep warm, clamp and cut cord, assess for need for BVM ventilation",correct:true,explanation:"Per Protocol 02.16/02.17: Dry, stimulate, suction, keep warm. If no improvement, begin BVM ventilation at 40-60 breaths/min.",protocol_ref:"02.16"},
   {text:"Immediately clamp and cut the cord and hand to the mother",correct:false,explanation:"The priority is assessment and resuscitation of the newborn, not cord management.",protocol_ref:"02.16"},
   {text:"Wait 5 minutes — all babies look blue at first",correct:false,explanation:"A limp, non-crying, cyanotic newborn requires immediate intervention.",protocol_ref:"02.16"},
   {text:"Start chest compressions immediately",correct:false,explanation:"Start with drying, stimulation, and ventilation. Chest compressions are only for HR <60 despite adequate ventilation.",protocol_ref:"02.16"}
  ]}
]}
];
// App State
let state = {
  screen: 'home', // home, select, scenario, debrief
  level: null,
  currentScenario: null,
  questionIndex: 0,
  answers: [],
  answered: false,
  selectedOptions: new Set()
};

const app = document.getElementById('app');

function render() {
  switch(state.screen) {
    case 'home': renderHome(); break;
    case 'select': renderSelect(); break;
    case 'scenario': renderScenario(); break;
    case 'debrief': renderDebrief(); break;
  }
  window.scrollTo(0, 0);
}

function renderHome() {
  app.innerHTML = `
    <h1>🚑 RI EMS Scenario Trainer</h1>
    <p class="subtitle">Train with real Rhode Island protocols</p>
    <p style="text-align:center;color:#8b92a8;font-size:.85em;margin-bottom:24px">Select your certification level</p>
    <div class="level-cards">
      <div class="card level-card" data-level="E" onclick="selectLevel('E')">
        EMT
        <div class="desc">Emergency Medical Technician</div>
      </div>
      <div class="card level-card" data-level="A" onclick="selectLevel('A')">
        AEMT
        <div class="desc">Advanced EMT</div>
      </div>
      <div class="card level-card" data-level="C" onclick="selectLevel('C')">
        AEMT-C
        <div class="desc">Advanced EMT-Cardiac</div>
      </div>
      <div class="card level-card" data-level="P" onclick="selectLevel('P')">
        Paramedic
        <div class="desc">Paramedic</div>
      </div>
    </div>
  `;
}

function selectLevel(level) {
  state.level = level;
  state.screen = 'select';
  render();
}

function getAvailableScenarios() {
  const levelOrder = {E:1, A:2, C:3, P:4};
  const userLevel = levelOrder[state.level] || 1;
  return SCENARIOS.filter(s => {
    const minLevel = levelOrder[s.level_min] || 1;
    return userLevel >= minLevel;
  });
}

function renderSelect() {
  const scenarios = getAvailableScenarios();
  const categories = {};
  scenarios.forEach(s => {
    if (!categories[s.category]) categories[s.category] = [];
    categories[s.category].push(s);
  });

  let html = `
    <button class="back-btn" onclick="state.screen='home';render()">Back</button>
    <h1 style="font-size:1.3em;margin-bottom:4px">Choose a Scenario</h1>
    <p class="subtitle">${scenarios.length} scenarios available</p>
    <button class="btn btn-primary" onclick="startRandom()" style="margin-bottom:20px">🎲 Random Scenario</button>
  `;

  for (const [cat, items] of Object.entries(categories)) {
    html += `<div class="category-header">${cat}</div>`;
    items.forEach(s => {
      const diffClass = s.difficulty === 'Easy' ? 'tag-easy' : s.difficulty === 'Medium' ? 'tag-medium' : 'tag-hard';
      html += `
        <div class="card" onclick="startScenario('${s.id}')" style="margin-bottom:8px">
          <div class="scenario-item">
            <div>
              <div class="title">${s.title}</div>
              <div class="tags" style="margin-top:6px">
                <span class="tag ${diffClass}">${s.difficulty}</span>
                <span class="tag tag-proto">${s.primary_protocol}</span>
              </div>
            </div>
            <span style="color:#8b92a8">›</span>
          </div>
        </div>`;
    });
  }

  app.innerHTML = html;
}

function startRandom() {
  const scenarios = getAvailableScenarios();
  const s = scenarios[Math.floor(Math.random() * scenarios.length)];
  startScenario(s.id);
}

function startScenario(id) {
  state.currentScenario = SCENARIOS.find(s => s.id === id);
  state.questionIndex = 0;
  state.answers = [];
  state.answered = false;
  state.selectedOptions = new Set();
  state.screen = 'scenario';
  render();
}

function getFilteredQuestions() {
  const levelMap = {E:'E', A:'A', C:'C', P:'P'};
  const userLevel = state.level;
  return state.currentScenario.questions.filter(q => {
    return q.level_filter.includes(userLevel);
  });
}

function renderScenario() {
  const s = state.currentScenario;
  const questions = getFilteredQuestions();
  
  if (state.questionIndex >= questions.length) {
    state.screen = 'debrief';
    render();
    return;
  }

  const q = questions[state.questionIndex];
  const phases = ['scene','assessment','treatment','transport'];
  const phaseLabels = {scene:'Scene Size-Up',assessment:'Assessment',treatment:'Treatment',transport:'Transport'};
  
  // Progress bar
  let progressHtml = '<div class="progress-bar">';
  const usedPhases = [...new Set(questions.map(qq => qq.phase))];
  usedPhases.forEach(p => {
    const qIdx = questions.findIndex(qq => qq.phase === p);
    let cls = '';
    if (p === q.phase) cls = 'active';
    else if (qIdx < state.questionIndex) cls = 'done';
    progressHtml += `<div class="progress-step ${cls}">${phaseLabels[p] || p}</div>`;
  });
  progressHtml += '</div>';

  // Vitals
  let vitalsHtml = '';
  if (s.vitals && state.questionIndex === 0) {
    const v = s.vitals;
    vitalsHtml = `
      <div class="narrative">
        <div class="label">Vitals</div>
        <div class="vitals-grid">
          ${v.hr !== undefined ? `<div class="vital"><div class="val">${v.hr}</div><div class="lbl">HR</div></div>` : ''}
          ${v.bp ? `<div class="vital"><div class="val">${v.bp}</div><div class="lbl">BP</div></div>` : ''}
          ${v.rr !== undefined ? `<div class="vital"><div class="val">${v.rr}</div><div class="lbl">RR</div></div>` : ''}
          ${v.spo2 !== undefined ? `<div class="vital"><div class="val">${v.spo2}${typeof v.spo2 === 'number' ? '%' : ''}</div><div class="lbl">SpO₂</div></div>` : ''}
          ${v.gcs !== undefined ? `<div class="vital"><div class="val">${v.gcs}</div><div class="lbl">GCS</div></div>` : ''}
          ${v.temp ? `<div class="vital"><div class="val">${v.temp}</div><div class="lbl">Temp</div></div>` : ''}
          ${v.bg ? `<div class="vital"><div class="val">${v.bg}</div><div class="lbl">BG</div></div>` : ''}
        </div>
      </div>`;
  }

  // Build HTML
  let html = `
    <button class="back-btn" onclick="state.screen='select';render()">Exit Scenario</button>
    ${progressHtml}
    <div style="margin-bottom:6px"><span class="tag tag-proto">${s.primary_protocol}</span> <span style="color:#8b92a8;font-size:.85em">${s.title}</span></div>
  `;

  // Show dispatch/scene on first question
  if (state.questionIndex === 0) {
    html += `
      <div class="narrative">
        <div class="label">📟 Dispatch</div>
        ${s.dispatch}
      </div>
      <div class="narrative">
        <div class="label">🏥 Scene</div>
        ${s.scene}
      </div>
      <div class="narrative">
        <div class="label">👤 Patient</div>
        ${s.patient.age}yo ${s.patient.sex === 'M' ? 'male' : 'female'} — ${s.patient.cc}<br>
        <span style="color:#8b92a8;font-size:.9em">PMH: ${s.history.pmh} | Meds: ${s.history.meds} | Allergies: ${s.history.allergies}</span>
      </div>
      <div class="narrative">
        <div class="label">🔍 Presentation</div>
        ${s.presentation}
      </div>
      ${vitalsHtml}
    `;
  }

  html += `
    <div class="phase-label">${phaseLabels[q.phase] || q.phase}</div>
    <div class="question-prompt">Question ${state.questionIndex + 1} of ${questions.length}: ${q.prompt}</div>
  `;

  if (q.multi_select) {
    html += `<div class="multi-hint">Select all that apply</div>`;
  }

  // Shuffle options (seeded per question to stay stable on re-render)
  if (!q._shuffled) {
    for (let j = q.options.length - 1; j > 0; j--) {
      const k = Math.floor(Math.random() * (j + 1));
      [q.options[j], q.options[k]] = [q.options[k], q.options[j]];
    }
    q._shuffled = true;
  }

  // Options
  q.options.forEach((opt, i) => {
    let cls = 'option';
    let extra = '';
    
    if (state.answered) {
      if (opt.correct) {
        cls += ' correct';
        extra = `<div class="explanation"><span class="indicator"></span> ✅ ${opt.explanation} <span class="ref">(${opt.protocol_ref})</span></div>`;
      } else if (state.selectedOptions.has(i)) {
        cls += ' incorrect';
        extra = `<div class="explanation"><span class="indicator"></span> ❌ ${opt.explanation} <span class="ref">(${opt.protocol_ref})</span></div>`;
      }
    } else {
      if (state.selectedOptions.has(i)) cls += ' selected';
    }

    html += `
      <div class="${cls}" onclick="selectOption(${i})">
        ${opt.text}
        ${extra}
      </div>`;
  });

  // Button
  if (!state.answered) {
    const disabled = state.selectedOptions.size === 0 ? 'disabled' : '';
    html += `<button class="btn btn-primary" onclick="submitAnswer()" ${disabled}>Submit Answer</button>`;
  } else {
    const isLast = state.questionIndex + 1 >= questions.length;
    const label = isLast ? 'View Results 📊' : 'Next Question →';
    html += `<button class="btn btn-primary" onclick="nextQuestion()">${label}</button>`;
  }

  app.innerHTML = `<div class="fade-in">${html}</div>`;
}

function selectOption(i) {
  if (state.answered) return;
  const q = getFilteredQuestions()[state.questionIndex];
  if (q.multi_select) {
    if (state.selectedOptions.has(i)) state.selectedOptions.delete(i);
    else state.selectedOptions.add(i);
  } else {
    state.selectedOptions = new Set([i]);
  }
  renderScenario();
}

function submitAnswer() {
  if (state.selectedOptions.size === 0) return;
  state.answered = true;
  
  const q = getFilteredQuestions()[state.questionIndex];
  const correctIndices = new Set(q.options.map((o,i) => o.correct ? i : -1).filter(i => i >= 0));
  const selected = state.selectedOptions;
  
  // Check if correct
  let isCorrect = false;
  if (q.multi_select) {
    isCorrect = selected.size === correctIndices.size && [...selected].every(i => correctIndices.has(i));
  } else {
    isCorrect = selected.size === 1 && correctIndices.has([...selected][0]);
  }

  state.answers.push({
    question: q.prompt,
    phase: q.phase,
    correct: isCorrect,
    selected: [...selected].map(i => q.options[i].text),
    correctAnswer: q.options.filter(o => o.correct).map(o => o.text),
    protocol: q.options.find(o => o.correct)?.protocol_ref || ''
  });

  renderScenario();
}

function nextQuestion() {
  state.questionIndex++;
  state.answered = false;
  state.selectedOptions = new Set();
  render();
}

function renderDebrief() {
  const s = state.currentScenario;
  const total = state.answers.length;
  const correct = state.answers.filter(a => a.correct).length;
  const pct = total > 0 ? Math.round(correct / total * 100) : 0;
  
  let scoreClass = 'score-bad';
  if (pct >= 80) scoreClass = 'score-good';
  else if (pct >= 60) scoreClass = 'score-ok';

  let html = `
    <h1 style="font-size:1.3em;text-align:center">📊 Scenario Debrief</h1>
    <p style="text-align:center;color:#8b92a8;margin-bottom:16px">${s.title}</p>
    
    <div class="score-circle ${scoreClass}">
      ${correct}/${total}
      <div class="pct">${pct}%</div>
    </div>
    
    <p style="text-align:center;margin:16px 0;font-size:.95em">
      ${pct >= 80 ? '🎉 Excellent work! Strong protocol knowledge.' : 
        pct >= 60 ? '👍 Good effort. Review the protocols you missed.' : 
        '📚 Keep studying. Review the referenced protocols.'}
    </p>
    
    <div class="category-header">Question Review</div>
  `;

  state.answers.forEach((a, i) => {
    const icon = a.correct ? '✅' : '❌';
    html += `
      <div class="review-item">
        <div class="q">${icon} Q${i+1}: ${a.question}</div>
        <div class="your-ans ${a.correct ? '' : 'wrong'}">Your answer: ${a.selected.join(', ')}</div>
        ${!a.correct ? `<div class="correct-ans">Correct: ${a.correctAnswer.join(', ')}</div>` : ''}
        <div style="margin-top:4px"><span class="tag tag-proto">${a.protocol}</span></div>
      </div>`;
  });

  html += `
    <button class="btn btn-primary" onclick="startRandom()" style="margin-top:16px">🎲 Next Random Scenario</button>
    <button class="btn btn-secondary" onclick="startScenario('${s.id}')">🔄 Try Again</button>
    <button class="btn btn-secondary" onclick="state.screen='select';render()">← Choose Another Scenario</button>
    <button class="btn btn-secondary" onclick="state.screen='home';render()">🏠 Home</button>
    <div style="height:40px"></div>
  `;

  app.innerHTML = `<div class="fade-in">${html}</div>`;
}

// Start
render();
</script>
</body></html>
