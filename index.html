<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0e1a">
<title>RI EMS Scenario Trainer</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{overflow-y:scroll;-webkit-text-size-adjust:100%}
body{font-family:-apple-system,SF Pro,Inter,system-ui,sans-serif;background:#0a0e1a;color:#fff;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  touch-action:pan-y;min-height:100dvh}
.container{max-width:600px;margin:0 auto;padding:16px}
h1{font-size:1.6em;text-align:center;margin:20px 0 4px}
.subtitle{text-align:center;color:#8b92a8;margin-bottom:24px;font-size:.95em}
.card{background:#141929;border-radius:12px;padding:16px;margin-bottom:12px;transition:all .2s;cursor:pointer;border:2px solid transparent}
.card:active{transform:scale(.98)}
.card.selected{border-color:#d9534f}
.level-cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.level-card{text-align:center;padding:20px 12px;font-weight:600;font-size:1.1em}
.level-card .desc{font-size:.75em;font-weight:400;color:#8b92a8;margin-top:6px}
.level-card[data-level="E"]{border-color:#f0ad4e;color:#f0ad4e}
.level-card[data-level="E"].selected{background:rgba(240,173,78,.15);border-color:#f0ad4e}
.level-card[data-level="A"]{border-color:#34c759;color:#34c759}
.level-card[data-level="A"].selected{background:rgba(52,199,89,.15);border-color:#34c759}
.level-card[data-level="C"]{border-color:#4a9eff;color:#4a9eff}
.level-card[data-level="C"].selected{background:rgba(74,158,255,.15);border-color:#4a9eff}
.level-card[data-level="P"]{border-color:#d9534f;color:#d9534f}
.level-card[data-level="P"].selected{background:rgba(217,83,79,.15);border-color:#d9534f}
.btn{display:block;width:100%;padding:14px;border:none;border-radius:12px;font-size:1em;font-weight:600;cursor:pointer;transition:all .2s;text-align:center;margin-top:12px}
.btn:active{transform:scale(.97)}
.btn-primary{background:#d9534f;color:#fff}
.btn-primary:disabled{background:#333;color:#666;cursor:not-allowed}
.btn-secondary{background:#1e2440;color:#fff;border:1px solid #2a3154}
.btn-small{display:inline-block;width:auto;padding:8px 16px;font-size:.9em;margin:4px}
.progress-bar{display:flex;gap:4px;margin-bottom:20px}
.progress-step{flex:1;text-align:center;font-size:.7em;color:#8b92a8;padding-bottom:8px;border-bottom:3px solid #1e2440}
.progress-step.active{color:#d9534f;border-color:#d9534f}
.progress-step.done{color:#34c759;border-color:#34c759}
.narrative{background:#141929;border-radius:12px;padding:16px;margin-bottom:16px;line-height:1.6;font-size:.95em}
.narrative .label{color:#d9534f;font-weight:600;font-size:.8em;text-transform:uppercase;margin-bottom:6px}
.vitals-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:12px 0}
.vital{background:#0d1020;border-radius:8px;padding:8px;text-align:center}
.vital .val{font-size:1.1em;font-weight:600}
.vital .lbl{font-size:.7em;color:#8b92a8;margin-top:2px}
.option{background:#141929;border-radius:12px;padding:14px 16px;margin-bottom:8px;cursor:pointer;border:2px solid #1e2440;transition:all .2s;line-height:1.4}
.option:active{transform:scale(.98)}
.option.selected{border-color:#4a9eff;background:rgba(74,158,255,.1)}
.option.correct{border-color:#34c759;background:rgba(52,199,89,.15)}
.option.incorrect{border-color:#d9534f;background:rgba(217,83,79,.15)}
.option.missed{border-color:#f0ad4e;background:rgba(240,173,78,.1)}
.option .indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px;vertical-align:middle}
.option.correct .indicator{background:#34c759}
.option.incorrect .indicator{background:#d9534f}
.option.missed .indicator{background:#f0ad4e}
.explanation{font-size:.85em;color:#8b92a8;margin-top:8px;padding:10px;background:#0d1020;border-radius:8px;line-height:1.5}
.explanation .ref{color:#4a9eff;font-weight:500}
.question-prompt{font-size:1em;font-weight:500;margin-bottom:12px;line-height:1.5}
.multi-hint{font-size:.8em;color:#8b92a8;margin-bottom:8px}
.score-circle{width:120px;height:120px;border-radius:50%;margin:20px auto;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:2em;font-weight:700}
.score-good{background:rgba(52,199,89,.2);color:#34c759;border:3px solid #34c759}
.score-ok{background:rgba(240,173,78,.2);color:#f0ad4e;border:3px solid #f0ad4e}
.score-bad{background:rgba(217,83,79,.2);color:#d9534f;border:3px solid #d9534f}
.score-circle .pct{font-size:.4em;font-weight:400}
.review-item{background:#141929;border-radius:12px;padding:14px;margin-bottom:10px}
.review-item .q{font-weight:500;margin-bottom:6px;font-size:.95em}
.review-item .your-ans{font-size:.85em;margin-bottom:4px}
.review-item .correct-ans{font-size:.85em;color:#34c759}
.review-item .wrong{color:#d9534f}
.tag{display:inline-block;padding:3px 8px;border-radius:6px;font-size:.7em;font-weight:600;margin-right:4px}
.tag-easy{background:rgba(52,199,89,.2);color:#34c759}
.tag-medium{background:rgba(240,173,78,.2);color:#f0ad4e}
.tag-hard{background:rgba(217,83,79,.2);color:#d9534f}
.tag-proto{background:rgba(74,158,255,.2);color:#4a9eff}
.category-header{color:#8b92a8;font-size:.8em;font-weight:600;text-transform:uppercase;margin:16px 0 8px;letter-spacing:.5px}
.scenario-item{display:flex;justify-content:space-between;align-items:center}
.scenario-item .title{font-weight:500;font-size:.95em}
.scenario-item .tags{margin-top:4px}
.hidden{display:none!important}
.fade-in{animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.back-btn{background:none;border:none;color:#8b92a8;font-size:.9em;cursor:pointer;padding:8px 0;display:flex;align-items:center;gap:4px}
.back-btn:before{content:'←'}
.phase-label{display:inline-block;background:rgba(217,83,79,.2);color:#d9534f;padding:4px 10px;border-radius:6px;font-size:.75em;font-weight:600;margin-bottom:12px;text-transform:uppercase}
</style>
</head>
<body>
<div class="container" id="app"></div>

<script>
const SCENARIOS = [
// ── MEDICAL ──
{id:"med-acs-01",title:"Crushing Chest Pain",category:"Medical",difficulty:"Medium",
dispatch:"Respond to a restaurant for a 62-year-old male with chest pain.",
patient:{age:62,sex:"M",cc:"Crushing chest pain"},
scene:"Restaurant. Patient seated, diaphoretic, clutching his chest. Patron called 911.",
vitals:{hr:96,bp:"164/98",rr:22,spo2:94,gcs:15,temp:"98.6°F",bg:"142 mg/dL"},
history:{pmh:"HTN, hyperlipidemia, former smoker",meds:"Lisinopril, atorvastatin",allergies:"NKDA"},
presentation:"Diaphoretic male with substernal crushing chest pain radiating to left arm. Onset 20 minutes ago. Pain 8/10. Mild dyspnea.",
primary_protocol:"03.02",related_protocols:["01.01"],level_min:"E",
questions:[
 {phase:"assessment",prompt:"What is your primary clinical impression?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Acute Coronary Syndrome — crushing substernal chest pain, diaphoresis, radiation to left arm, cardiac risk factors",correct:true,explanation:"Classic ACS presentation: substernal chest pain with radiation, diaphoresis, dyspnea, and significant cardiac risk factors.",protocol_ref:"03.02"},
   {text:"Pulmonary embolism",correct:false,explanation:"While PE can cause chest pain and dyspnea, the crushing substernal quality with left arm radiation is more classic for ACS.",protocol_ref:"03.02"},
   {text:"Gastroesophageal reflux",correct:false,explanation:"GERD can mimic cardiac pain, but with these risk factors and presentation, ACS must be assumed.",protocol_ref:"03.02"},
   {text:"Anxiety attack",correct:false,explanation:"Never assume anxiety in a 62yo male with cardiac risk factors and classic symptoms.",protocol_ref:"03.02"}
  ]},
 {phase:"treatment",prompt:"What is your initial treatment for this patient?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Aspirin 324mg (4 x 81mg chewed) and assist with patient's prescribed nitroglycerin if SBP ≥ 100",correct:true,explanation:"Per Protocol 03.02: Aspirin 81mg x4 orally (chewed) unless allergic. For patients prescribed nitroglycerin with SBP ≥ 100, administer 0.3/0.4mg SL.",protocol_ref:"03.02"},
   {text:"Nitroglycerin only, no aspirin needed in the field",correct:false,explanation:"Aspirin is a critical early intervention for ACS. Both aspirin and nitro (if prescribed) should be given.",protocol_ref:"03.02"},
   {text:"Morphine 4mg IV for pain control first",correct:false,explanation:"Morphine is not first-line. Aspirin and nitro are priority interventions.",protocol_ref:"03.02"},
   {text:"Apply oxygen only and transport",correct:false,explanation:"While oxygen may be indicated, aspirin should not be delayed.",protocol_ref:"03.02"}
  ]},
 {phase:"treatment",prompt:"A 12-lead ECG shows ST elevation in leads II, III, and aVF. What is your next action?",multi_select:false,level_filter:"ACP",
  options:[
   {text:"Transmit ECG to medical control at nearest PCI facility, activate CODE STEMI, limit scene time to ≤ 10 minutes",correct:true,explanation:"Per Protocol 03.02: If ECG suggestive of STEMI — limit scene time ≤ 10 min, triage to nearest PCI capable facility, provide immediate CODE STEMI notification.",protocol_ref:"03.02"},
   {text:"Transport to the nearest emergency department regardless of PCI capability",correct:false,explanation:"STEMI patients should be triaged to a PCI-capable facility for timely intervention.",protocol_ref:"03.02"},
   {text:"Administer thrombolytics in the field",correct:false,explanation:"Field thrombolytics are not part of RI protocol. PCI is the preferred reperfusion strategy.",protocol_ref:"03.02"},
   {text:"Wait for a second ECG to confirm before activating STEMI alert",correct:false,explanation:"Do not delay STEMI activation. Time is myocardium.",protocol_ref:"03.02"}
  ]},
 {phase:"transport",prompt:"Where should this STEMI patient be transported?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Nearest PCI-capable facility with CODE STEMI activation",correct:true,explanation:"Per Protocol 03.02: STEMI patients are triaged to the nearest PCI-capable facility.",protocol_ref:"03.02"},
   {text:"Closest hospital regardless of capabilities",correct:false,explanation:"STEMI patients benefit from direct transport to PCI-capable facilities.",protocol_ref:"03.02"},
   {text:"Patient's preferred hospital",correct:false,explanation:"Patient preference does not override clinical need for PCI.",protocol_ref:"03.02"},
   {text:"Hospital with the shortest wait time",correct:false,explanation:"PCI capability is the determining factor, not wait time.",protocol_ref:"03.02"}
  ]}
]},

{id:"med-stroke-01",title:"Sudden Facial Droop",category:"Medical",difficulty:"Medium",
dispatch:"Respond to a home for a 71-year-old female with slurred speech.",
patient:{age:71,sex:"F",cc:"Slurred speech, facial droop"},
scene:"Living room. Patient seated in recliner, right-sided facial droop, unable to lift right arm.",
vitals:{hr:88,bp:"178/96",rr:16,spo2:97,gcs:13,temp:"98.2°F",bg:"118 mg/dL"},
history:{pmh:"Atrial fibrillation, HTN, diabetes",meds:"Warfarin, metformin, metoprolol",allergies:"Sulfa"},
presentation:"Right-sided facial droop, right arm weakness, slurred speech. Symptoms noticed by husband 25 minutes ago. Last known well 45 minutes ago.",
primary_protocol:"02.12",related_protocols:["01.01"],level_min:"E",
questions:[
 {phase:"assessment",prompt:"Based on your assessment, what is your primary impression?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Acute ischemic stroke — sudden onset facial droop, arm weakness, speech changes with identifiable last known well time",correct:true,explanation:"Sudden onset unilateral facial droop, arm weakness, and speech difficulty are hallmark stroke symptoms. Cincinnati Stroke Scale is positive.",protocol_ref:"02.12"},
   {text:"Bell's palsy",correct:false,explanation:"Bell's palsy affects the entire side of the face and doesn't cause arm weakness or speech changes.",protocol_ref:"02.12"},
   {text:"Hypoglycemia",correct:false,explanation:"Blood glucose is 118 mg/dL — normal. Hypoglycemia can mimic stroke but is ruled out here.",protocol_ref:"02.12"},
   {text:"TIA — it will resolve on its own",correct:false,explanation:"You cannot distinguish TIA from stroke in the field. Treat as stroke and transport emergently.",protocol_ref:"02.12"}
  ]},
 {phase:"treatment",prompt:"What is critical to document for this patient?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Last known well time, stroke scale findings, blood glucose, and current anticoagulant use",correct:true,explanation:"Per Protocol 02.12: Establish and document last known well time, perform stroke assessment, blood glucose, and note anticoagulant use — all critical for hospital treatment decisions.",protocol_ref:"02.12"},
   {text:"Only the time you arrived on scene",correct:false,explanation:"Last known well time is far more important than EMS arrival time for treatment decisions.",protocol_ref:"02.12"},
   {text:"Family medical history",correct:false,explanation:"While useful, LKW time and stroke scale are the priority documentation.",protocol_ref:"02.12"},
   {text:"Detailed medication reconciliation",correct:false,explanation:"Anticoagulant use is important but LKW time is the most critical piece.",protocol_ref:"02.12"}
  ]},
 {phase:"transport",prompt:"Where should this patient be transported?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Nearest certified stroke center with pre-arrival notification",correct:true,explanation:"Per Protocol 02.12: Transport to nearest appropriate stroke center. Pre-notify the receiving facility.",protocol_ref:"02.12"},
   {text:"Closest hospital",correct:false,explanation:"Stroke patients should go to stroke-capable facilities for time-sensitive interventions.",protocol_ref:"02.12"},
   {text:"Patient's PCP office",correct:false,explanation:"Acute stroke requires emergency department evaluation, not outpatient care.",protocol_ref:"02.12"},
   {text:"Hospital closest to patient's home for family convenience",correct:false,explanation:"Stroke center capability takes priority over convenience.",protocol_ref:"02.12"}
  ]}
]},

{id:"med-allergy-01",title:"Severe Allergic Reaction",category:"Medical",difficulty:"Easy",
dispatch:"Respond to a park for a 34-year-old female with difficulty breathing after a bee sting.",
patient:{age:34,sex:"F",cc:"Difficulty breathing, bee sting"},
scene:"City park. Patient standing, visibly distressed, hives on arms and neck, audible wheezing.",
vitals:{hr:118,bp:"88/54",rr:28,spo2:91,gcs:15,temp:"98.4°F"},
history:{pmh:"Bee sting allergy (carries EpiPen)",meds:"None daily",allergies:"Bee venom"},
presentation:"Diffuse urticaria, angioedema of lips, audible wheezing, tachycardic, hypotensive. Stung on right hand 10 minutes ago. Has EpiPen but hasn't used it.",
primary_protocol:"02.04A",related_protocols:["01.01","02.20A"],level_min:"E",
questions:[
 {phase:"assessment",prompt:"What severity classification does this patient meet?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Severe — respiratory distress with wheezing AND hypotension with poor perfusion",correct:true,explanation:"Per Protocol 02.04A: Severe = skin symptoms + respiratory (wheezing, dyspnea, hypoxia) OR GI symptoms WITH hypotension and poor perfusion.",protocol_ref:"02.04A"},
   {text:"Mild — just hives and itching",correct:false,explanation:"This patient has wheezing, hypotension, and angioedema — far beyond mild.",protocol_ref:"02.04A"},
   {text:"Moderate — respiratory symptoms with normal BP",correct:false,explanation:"BP is 88/54 — this patient is hypotensive, making this severe.",protocol_ref:"02.04A"},
   {text:"Not anaphylaxis — just an allergic reaction",correct:false,explanation:"Multi-system involvement (skin + respiratory + cardiovascular) defines anaphylaxis.",protocol_ref:"02.04A"}
  ]},
 {phase:"treatment",prompt:"What is your immediate intervention?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Epinephrine 0.3mg IM (auto-injector or check and inject) immediately",correct:true,explanation:"Per Protocol 02.04A: For severe allergic reaction/anaphylaxis, epinephrine is the first-line treatment. 0.3mg IM via auto-injector preferred.",protocol_ref:"02.04A"},
   {text:"Diphenhydramine (Benadryl) first, then consider epinephrine",correct:false,explanation:"Epinephrine is FIRST-LINE for anaphylaxis. Antihistamines are secondary and do not treat the cardiovascular collapse.",protocol_ref:"02.04A"},
   {text:"Albuterol nebulizer for the wheezing",correct:false,explanation:"While albuterol may help wheezing, epinephrine is the priority in anaphylaxis.",protocol_ref:"02.04A"},
   {text:"Assist with patient's own EpiPen only if she can self-administer",correct:false,explanation:"EMTs can administer epinephrine via auto-injector per protocol. Don't wait for self-administration.",protocol_ref:"02.04A"}
  ]},
 {phase:"transport",prompt:"The patient's symptoms improve after epinephrine. What is your transport decision?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Transport to hospital — anaphylaxis can have a biphasic reaction requiring monitoring",correct:true,explanation:"All anaphylaxis patients require hospital evaluation and monitoring for biphasic reaction, even if symptoms improve.",protocol_ref:"02.04A"},
   {text:"Patient can refuse transport since symptoms improved",correct:false,explanation:"Strongly encourage transport. Biphasic reactions can occur hours later and be life-threatening.",protocol_ref:"02.04A"},
   {text:"Release to family with instructions to take Benadryl",correct:false,explanation:"Anaphylaxis requires emergency department evaluation regardless of field improvement.",protocol_ref:"02.04A"},
   {text:"Wait on scene 30 minutes to see if symptoms return",correct:false,explanation:"Transport should not be delayed. Monitor en route.",protocol_ref:"02.04A"}
  ]}
]},

{id:"med-seizure-01",title:"Active Seizure",category:"Medical",difficulty:"Easy",
dispatch:"Respond to an office building for a 28-year-old male having a seizure.",
patient:{age:28,sex:"M",cc:"Seizure activity"},
scene:"Office break room. Patient on floor, tonic-clonic activity. Coworkers holding him down.",
vitals:{hr:112,bp:"156/92",rr:8,spo2:86,gcs:3,temp:"99.8°F",bg:"94 mg/dL"},
history:{pmh:"Epilepsy",meds:"Levetiracetam (Keppra)",allergies:"NKDA"},
presentation:"Active generalized tonic-clonic seizure. Coworkers state it started approximately 3 minutes ago. Cyanotic around lips.",
primary_protocol:"02.19A",related_protocols:["01.01","05.01A"],level_min:"E",
questions:[
 {phase:"scene",prompt:"Coworkers are holding the patient down. What is your first action?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Have coworkers stop restraining the patient, protect from injury, do not place anything in the mouth",correct:true,explanation:"Per Protocol 02.19A: Do not restrain. Protect from injury. Never place anything in the patient's mouth during a seizure.",protocol_ref:"02.19A"},
   {text:"Help the coworkers hold him more firmly to prevent injury",correct:false,explanation:"Restraining a seizing patient can cause injury. Protect but do not restrain.",protocol_ref:"02.19A"},
   {text:"Place a bite block between the teeth",correct:false,explanation:"Never place anything in the mouth of a seizing patient.",protocol_ref:"02.19A"},
   {text:"Immediately attempt to start an IV",correct:false,explanation:"IV access during active tonic-clonic seizure is not practical or priority. Protect the patient first.",protocol_ref:"02.19A"}
  ]},
 {phase:"treatment",prompt:"The seizure continues for 5+ minutes. What medication intervention is indicated?",multi_select:false,level_filter:"CP",
  options:[
   {text:"Midazolam 5mg IM/IN for status epilepticus",correct:true,explanation:"Per Protocol 02.19A: For prolonged seizure activity, midazolam is the first-line benzodiazepine. IM or IN routes preferred when IV not available.",protocol_ref:"02.19A"},
   {text:"Diazepam 10mg orally",correct:false,explanation:"Oral medication is not appropriate during active seizure — aspiration risk.",protocol_ref:"02.19A"},
   {text:"Phenytoin IV push",correct:false,explanation:"Phenytoin is not a prehospital medication in RI protocols.",protocol_ref:"02.19A"},
   {text:"No medication — seizures always stop on their own",correct:false,explanation:"Status epilepticus (>5 min) is life-threatening and requires benzodiazepine intervention.",protocol_ref:"02.19A"}
  ]}
]},

{id:"med-resp-01",title:"Asthma Exacerbation",category:"Medical",difficulty:"Easy",
dispatch:"Respond to a school for a 16-year-old with difficulty breathing.",
patient:{age:16,sex:"F",cc:"Can't breathe, asthma attack"},
scene:"School nurse's office. Patient sitting upright, using accessory muscles, audible wheezing.",
vitals:{hr:124,bp:"130/80",rr:30,spo2:89,gcs:15,temp:"98.6°F"},
history:{pmh:"Asthma, uses rescue inhaler",meds:"Albuterol MDI (own)",allergies:"NKDA"},
presentation:"Severe respiratory distress. Tripod positioning. Diffuse bilateral wheezing. Speaking in 2-3 word sentences. Already used her inhaler twice with no relief.",
primary_protocol:"02.08A",related_protocols:["01.01","05.01A"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"The patient has already used her inhaler twice. What is your treatment?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Albuterol 2.5mg via nebulizer with ipratropium bromide 500mcg, supplemental oxygen",correct:true,explanation:"Per Protocol 02.08A: Albuterol via nebulizer with ipratropium bromide for severe respiratory distress. Additional treatments may be repeated.",protocol_ref:"02.08A"},
   {text:"No more bronchodilators since she already used her inhaler",correct:false,explanation:"EMS-administered nebulized albuterol is indicated even if the patient has used their own inhaler.",protocol_ref:"02.08A"},
   {text:"Oxygen only by nasal cannula",correct:false,explanation:"While oxygen is needed, bronchodilator therapy is the primary treatment for bronchospasm.",protocol_ref:"02.08A"},
   {text:"Encourage slow breathing techniques only",correct:false,explanation:"Severe bronchospasm requires pharmacological intervention, not just coaching.",protocol_ref:"02.08A"}
  ]},
 {phase:"treatment",prompt:"Despite nebulizer treatment, the patient is worsening with SpO2 of 85%. What do you consider?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Epinephrine 0.3mg IM and initiate CPAP if available",correct:true,explanation:"Per Protocol 02.08A: Epinephrine IM for severe bronchospasm not responding to nebulized albuterol. CPAP/BiPAP if available and not contraindicated.",protocol_ref:"02.08A"},
   {text:"Continue the same nebulizer treatment and wait",correct:false,explanation:"Worsening despite treatment requires escalation, not repetition of the same intervention.",protocol_ref:"02.08A"},
   {text:"Intubate immediately",correct:false,explanation:"Intubation is a last resort in asthma. Epinephrine and CPAP should be tried first.",protocol_ref:"02.08A"},
   {text:"Nothing more can be done in the field",correct:false,explanation:"Epinephrine IM is available at EMT level and is indicated for severe refractory bronchospasm.",protocol_ref:"02.08A"}
  ]}
]},

// ── CARDIAC ──
{id:"card-arrest-01",title:"Witnessed Cardiac Arrest",category:"Cardiac",difficulty:"Hard",
dispatch:"Respond to a gym for an unresponsive male, bystander CPR in progress.",
patient:{age:55,sex:"M",cc:"Unresponsive, not breathing"},
scene:"Gym floor. Bystander performing CPR. Gym's AED is nearby but not yet applied.",
vitals:{hr:0,bp:"N/A",rr:0,spo2:"N/A",gcs:3},
history:{pmh:"Unknown",meds:"Unknown",allergies:"Unknown"},
presentation:"Unresponsive, apneic, pulseless. Bystander reports witnessed collapse approximately 4 minutes ago. Good quality bystander CPR ongoing.",
primary_protocol:"03.03A",related_protocols:["01.01"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"Bystander CPR is in progress. What is your immediate priority?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Apply AED/defibrillator immediately with minimal interruption to chest compressions",correct:true,explanation:"Per Protocol 03.03A: A defibrillator should be applied as soon as available and ECG rhythm analysis should immediately follow. Minimize interruptions in compressions.",protocol_ref:"03.03A"},
   {text:"Stop CPR to get a full history first",correct:false,explanation:"Never delay defibrillation for history. Apply the defibrillator immediately.",protocol_ref:"03.03A"},
   {text:"Start IV access before anything else",correct:false,explanation:"Defibrillation takes priority over IV access in cardiac arrest.",protocol_ref:"03.03A"},
   {text:"Intubate before applying the AED",correct:false,explanation:"Defibrillation and high-quality CPR take priority. Airway management is secondary.",protocol_ref:"03.03A"}
  ]},
 {phase:"treatment",prompt:"The AED analyzes ventricular fibrillation. What do you do?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Deliver shock immediately, then resume CPR for 2 minutes before reanalyzing",correct:true,explanation:"Per Protocol 03.03A and AHA guidelines: Deliver shock, immediately resume CPR for 2 minutes, then reanalyze. Minimize interruptions.",protocol_ref:"03.03A"},
   {text:"Deliver 3 stacked shocks before resuming CPR",correct:false,explanation:"Current guidelines call for single shock followed by immediate CPR, not stacked shocks.",protocol_ref:"03.03A"},
   {text:"Wait for ALS before shocking",correct:false,explanation:"Early defibrillation is critical for VF survival. Do not delay for ALS.",protocol_ref:"03.03A"},
   {text:"Perform 2 more minutes of CPR before the first shock",correct:false,explanation:"For witnessed VF arrest, immediate defibrillation is recommended.",protocol_ref:"03.03A"}
  ]},
 {phase:"treatment",prompt:"After 2 rounds of CPR and defibrillation, what additional interventions should be performed?",multi_select:false,level_filter:"CP",
  options:[
   {text:"Establish IV/IO access, administer epinephrine 1mg IV/IO, consider advanced airway",correct:true,explanation:"Per Protocol 03.03A: After initial CPR and defibrillation, establish vascular access and administer epinephrine. Consider advanced airway without interrupting compressions.",protocol_ref:"03.03A"},
   {text:"Continue CPR and defibrillation only — no medications needed",correct:false,explanation:"Epinephrine is indicated in cardiac arrest per protocol.",protocol_ref:"03.03A"},
   {text:"Administer amiodarone before epinephrine",correct:false,explanation:"Epinephrine is given first. Amiodarone is considered for refractory VF/VT.",protocol_ref:"03.03A"},
   {text:"Stop resuscitation after 2 unsuccessful shocks",correct:false,explanation:"Continue resuscitation efforts. Two rounds is far too early to consider termination.",protocol_ref:"03.03A"}
  ]}
]},

{id:"card-brady-01",title:"Symptomatic Bradycardia",category:"Cardiac",difficulty:"Medium",
dispatch:"Respond to a residence for a 78-year-old female feeling dizzy and weak.",
patient:{age:78,sex:"F",cc:"Dizziness, weakness"},
scene:"Bedroom. Patient lying in bed, pale, diaphoretic.",
vitals:{hr:36,bp:"76/48",rr:18,spo2:94,gcs:14,temp:"97.8°F",bg:"102 mg/dL"},
history:{pmh:"HTN, heart block",meds:"Metoprolol, lisinopril",allergies:"Penicillin"},
presentation:"Pale, diaphoretic female with severe bradycardia at 36 bpm. Altered mentation — oriented to person only. Hypotensive.",
primary_protocol:"03.05A",related_protocols:["01.01"],level_min:"E",
questions:[
 {phase:"assessment",prompt:"What makes this bradycardia symptomatic and requiring treatment?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Heart rate of 36 with hypotension, altered mental status, and poor perfusion (diaphoresis, pallor)",correct:true,explanation:"Symptomatic bradycardia = slow rate PLUS hemodynamic compromise: hypotension, altered mental status, signs of poor perfusion.",protocol_ref:"03.05A"},
   {text:"Heart rate below 60 always requires treatment",correct:false,explanation:"Bradycardia alone doesn't require treatment. It must be symptomatic with hemodynamic compromise.",protocol_ref:"03.05A"},
   {text:"Only the low blood pressure matters, not the heart rate",correct:false,explanation:"The bradycardia is CAUSING the symptoms. Both the rate and the hemodynamic effects matter.",protocol_ref:"03.05A"},
   {text:"This is normal for a 78-year-old",correct:false,explanation:"A heart rate of 36 with hypotension and altered mental status is not normal at any age.",protocol_ref:"03.05A"}
  ]},
 {phase:"treatment",prompt:"What is the paramedic treatment for this patient?",multi_select:false,level_filter:"P",
  options:[
   {text:"Atropine 0.5mg IV, may repeat; prepare for transcutaneous pacing if atropine ineffective",correct:true,explanation:"Per Protocol 03.05A: Atropine is first-line for symptomatic bradycardia. Transcutaneous pacing is indicated if atropine is ineffective.",protocol_ref:"03.05A"},
   {text:"Epinephrine 1mg IV push",correct:false,explanation:"Cardiac arrest dose epinephrine is not indicated. Atropine is first-line for symptomatic bradycardia.",protocol_ref:"03.05A"},
   {text:"Adenosine 6mg rapid IV push",correct:false,explanation:"Adenosine slows the heart — contraindicated in bradycardia. It's used for tachycardia.",protocol_ref:"03.05A"},
   {text:"Cardioversion at 100J",correct:false,explanation:"Cardioversion is for tachycardia. Bradycardia is treated with atropine and pacing.",protocol_ref:"03.05A"}
  ]}
]},

// ── TRAUMA ──
{id:"trauma-mva-01",title:"High-Speed MVC",category:"Trauma",difficulty:"Hard",
dispatch:"Respond to highway for a 2-vehicle MVC with entrapment.",
patient:{age:42,sex:"M",cc:"MVC with entrapment"},
scene:"Highway. Significant front-end damage, deployed airbags. Driver trapped by dashboard. Conscious and screaming in pain.",
vitals:{hr:128,bp:"86/58",rr:26,spo2:92,gcs:14,temp:"97.0°F"},
history:{pmh:"None known",meds:"Unknown",allergies:"Unknown"},
presentation:"Restrained driver, entrapped. Obvious deformity left femur. Abdominal tenderness. Tachycardic and hypotensive. Diaphoretic.",
primary_protocol:"04.01A",related_protocols:["04.03","04.04","04.05","02.21A"],level_min:"E",
questions:[
 {phase:"scene",prompt:"What are your scene management priorities?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Scene safety, request fire/rescue for extrication, spinal precautions, rapid trauma assessment",correct:true,explanation:"Per Protocol 04.01A: Scene safety first, request extrication resources, apply spinal precautions per protocol, perform rapid trauma assessment.",protocol_ref:"04.01A"},
   {text:"Immediately begin extrication yourself",correct:false,explanation:"Extrication requires specialized equipment and trained rescue personnel.",protocol_ref:"04.01A"},
   {text:"Wait for the patient to free himself",correct:false,explanation:"The patient is trapped and requires rescue extrication.",protocol_ref:"04.01A"},
   {text:"Focus only on the femur fracture",correct:false,explanation:"Multi-trauma requires a systematic approach, not tunnel vision on one injury.",protocol_ref:"04.01A"}
  ]},
 {phase:"treatment",prompt:"The patient is extricated. He's tachycardic at 128 and hypotensive at 86/58 with a deformed left femur. What do you prioritize?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Control hemorrhage, apply traction splint to femur, IV fluid resuscitation, rapid transport to trauma center",correct:true,explanation:"Per Protocols 04.01A/02.21A: Hemorrhage control is priority. Traction splint for femur fracture. IV fluids for hemorrhagic shock. Transport to Level 1 Trauma Center.",protocol_ref:"04.01A"},
   {text:"Splint all extremities before transport",correct:false,explanation:"In critical trauma with signs of shock, rapid transport takes priority. Splint the femur but don't delay for minor injuries.",protocol_ref:"04.01A"},
   {text:"Full spinal immobilization and detailed secondary survey on scene",correct:false,explanation:"Critical trauma patients get a rapid assessment and rapid transport. Detailed survey is done en route.",protocol_ref:"04.01A"},
   {text:"Wait for vital signs to stabilize before transport",correct:false,explanation:"This patient is in hemorrhagic shock. He needs a trauma center, not prolonged scene time.",protocol_ref:"04.01A"}
  ]},
 {phase:"transport",prompt:"Where should this patient be transported?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Level 1 Trauma Center — high-energy mechanism with signs of hemorrhagic shock and multi-system trauma",correct:true,explanation:"Per Protocol 04.01A: Multi-trauma with hemodynamic instability meets trauma center criteria. Transport to highest level trauma center.",protocol_ref:"04.01A"},
   {text:"Nearest community hospital to stabilize, then transfer",correct:false,explanation:"Direct transport to trauma center is preferred when accessible. Avoid unnecessary delays.",protocol_ref:"04.01A"},
   {text:"Orthopedic specialty hospital for the femur",correct:false,explanation:"Multi-system trauma requires a trauma center, not a specialty hospital.",protocol_ref:"04.01A"},
   {text:"Closest facility to start blood transfusion",correct:false,explanation:"Trauma center should be the destination for definitive care.",protocol_ref:"04.01A"}
  ]}
]},

{id:"trauma-burn-01",title:"Kitchen Burn Injury",category:"Trauma",difficulty:"Medium",
dispatch:"Respond to a residence for a burn injury.",
patient:{age:45,sex:"F",cc:"Burns to arms and chest"},
scene:"Kitchen. Grease fire on stove (extinguished). Patient with burns to both arms and anterior chest.",
vitals:{hr:108,bp:"138/82",rr:22,spo2:96,gcs:15,temp:"98.6°F"},
history:{pmh:"None",meds:"None",allergies:"NKDA"},
presentation:"Partial and full-thickness burns to bilateral forearms (circumferential) and anterior chest. Estimated 18% BSA. No facial burns, no soot in airway, voice normal.",
primary_protocol:"04.07A",related_protocols:["01.01","02.07A"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"What is your burn management for this patient?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Remove clothing/jewelry from burn areas, cover with dry sterile dressings, manage pain, IV fluid resuscitation",correct:true,explanation:"Per Protocol 04.07A: Remove clothing and jewelry, cover with dry sterile dressings, pain management, IV fluids for burns >15% BSA.",protocol_ref:"04.07A"},
   {text:"Apply ice directly to the burns",correct:false,explanation:"Ice can worsen burn injury and cause hypothermia. Cool running water is acceptable for small burns; cover with dry dressings.",protocol_ref:"04.07A"},
   {text:"Apply burn cream/ointment in the field",correct:false,explanation:"Do not apply ointments or creams. Cover with dry sterile dressings.",protocol_ref:"04.07A"},
   {text:"Pop any blisters to prevent infection",correct:false,explanation:"Do not break blisters. Cover with dry sterile dressings.",protocol_ref:"04.07A"}
  ]},
 {phase:"transport",prompt:"This patient has 18% BSA burns with circumferential forearm burns. Where should she be transported?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Burn center — meets burn center referral criteria with >10% BSA and circumferential extremity burns",correct:true,explanation:"Per Protocol 04.07A: Burns >10% BSA and circumferential burns meet burn center referral criteria.",protocol_ref:"04.07A"},
   {text:"Any emergency department",correct:false,explanation:"This patient meets burn center criteria due to BSA and circumferential burns.",protocol_ref:"04.07A"},
   {text:"Urgent care clinic",correct:false,explanation:"18% BSA burns with circumferential involvement require burn center care.",protocol_ref:"04.07A"},
   {text:"Patient can follow up with her own doctor",correct:false,explanation:"This is a significant burn requiring emergency and specialty care.",protocol_ref:"04.07A"}
  ]}
]},

// ── PEDIATRIC ──
{id:"peds-resp-01",title:"Pediatric Respiratory Distress",category:"Pediatric",difficulty:"Medium",
dispatch:"Respond to a daycare for a 3-year-old with difficulty breathing.",
patient:{age:3,sex:"M",cc:"Difficulty breathing, wheezing"},
scene:"Daycare. Child sitting in teacher's lap, retracting, audible wheezing. Teacher reports known asthmatic.",
vitals:{hr:140,bp:"90/60",rr:40,spo2:88,gcs:15,temp:"99.2°F"},
history:{pmh:"Asthma",meds:"Albuterol MDI (at home, not at daycare)",allergies:"NKDA"},
presentation:"3-year-old in severe respiratory distress. Intercostal and subcostal retractions. Bilateral wheezing. Speaking only in single words. Using accessory muscles.",
primary_protocol:"02.08P",related_protocols:["01.01","05.01P"],level_min:"E",
questions:[
 {phase:"assessment",prompt:"How do you classify this child's respiratory distress?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Severe — retractions, accessory muscle use, single-word speech, SpO2 88%, known asthmatic",correct:true,explanation:"Per Protocol 02.08P: Severe distress in children = poor air entry, extreme accessory muscle use, retractions, altered behavior, cyanosis and/or altered mental status.",protocol_ref:"02.08P"},
   {text:"Mild — child is still conscious",correct:false,explanation:"Consciousness alone doesn't define severity. Retractions, accessory muscle use, and SpO2 of 88% indicate severe distress.",protocol_ref:"02.08P"},
   {text:"Moderate — wheezing means air is still moving",correct:false,explanation:"The degree of retractions, accessory muscle use, and hypoxia indicate severe, not moderate distress.",protocol_ref:"02.08P"},
   {text:"Cannot assess severity without a peak flow measurement",correct:false,explanation:"Clinical assessment is sufficient. Peak flow is not practical in a 3-year-old.",protocol_ref:"02.08P"}
  ]},
 {phase:"treatment",prompt:"What is your treatment for this child?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Albuterol 2.5mg nebulizer with ipratropium 250mcg, high-flow oxygen, consider epinephrine if not improving",correct:true,explanation:"Per Protocol 02.08P: For severe pediatric respiratory distress, albuterol with ipratropium via nebulizer. Epinephrine IM if approaching respiratory failure.",protocol_ref:"02.08P"},
   {text:"Blow-by oxygen only",correct:false,explanation:"This child needs bronchodilator therapy, not just oxygen.",protocol_ref:"02.08P"},
   {text:"Adult dose albuterol (5mg) for faster relief",correct:false,explanation:"Use pediatric dosing: 2.5mg for age >2 years per protocol.",protocol_ref:"02.08P"},
   {text:"Wait for the child to calm down — it's probably just anxiety",correct:false,explanation:"SpO2 of 88% with retractions is not anxiety. This child needs immediate treatment.",protocol_ref:"02.08P"}
  ]}
]},

{id:"peds-arrest-01",title:"Pediatric Cardiac Arrest",category:"Pediatric",difficulty:"Hard",
dispatch:"Respond to a residence for a 6-year-old not breathing.",
patient:{age:6,sex:"F",cc:"Unresponsive, not breathing"},
scene:"Bedroom. Child unresponsive in bed. Parents frantic. No bystander CPR.",
vitals:{hr:0,bp:"N/A",rr:0,spo2:"N/A",gcs:3},
history:{pmh:"Recent upper respiratory infection",meds:"None",allergies:"NKDA"},
presentation:"Unresponsive, apneic, pulseless 6-year-old. Cyanotic. Parents report she was coughing all night and they found her unresponsive this morning.",
primary_protocol:"03.03P",related_protocols:["01.01","05.01P"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"What is the critical difference in pediatric vs adult cardiac arrest management?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Pediatric arrest is most often respiratory in etiology — ventilation and oxygenation are critical from the start",correct:true,explanation:"Per Protocol 03.03P: Unlike adults, pediatric cardiac arrest is most commonly caused by respiratory failure. Early effective ventilation is essential.",protocol_ref:"03.03P"},
   {text:"No difference — treat identically to adult arrest",correct:false,explanation:"Pediatric arrest has different etiologies and treatment priorities, especially early ventilation.",protocol_ref:"03.03P"},
   {text:"Always defibrillate first in pediatric arrest",correct:false,explanation:"Most pediatric arrests are non-shockable rhythms (PEA/asystole) from respiratory causes.",protocol_ref:"03.03P"},
   {text:"Pediatric patients don't need chest compressions",correct:false,explanation:"High-quality CPR is essential. Compression depth is 1/3 AP diameter of chest.",protocol_ref:"03.03P"}
  ]},
 {phase:"treatment",prompt:"The cardiac monitor shows asystole. What are your priorities?",multi_select:false,level_filter:"CP",
  options:[
   {text:"High-quality CPR with effective ventilation, epinephrine 0.01mg/kg IV/IO, identify and treat reversible causes",correct:true,explanation:"Per Protocol 03.03P: For non-shockable rhythm, high-quality CPR, epinephrine, and identify reversible causes (Hs and Ts).",protocol_ref:"03.03P"},
   {text:"Defibrillate at 2J/kg",correct:false,explanation:"Asystole is a non-shockable rhythm. Defibrillation is not indicated.",protocol_ref:"03.03P"},
   {text:"Atropine 0.5mg IV",correct:false,explanation:"Atropine is no longer routinely recommended for pediatric cardiac arrest.",protocol_ref:"03.03P"},
   {text:"CPR only — no medications for pediatric arrest",correct:false,explanation:"Epinephrine is indicated for pediatric cardiac arrest.",protocol_ref:"03.03P"}
  ]}
]},

// ── SPECIAL ──
{id:"spec-tox-01",title:"Opioid Overdose",category:"Special",difficulty:"Easy",
dispatch:"Respond to a park restroom for an unresponsive person.",
patient:{age:29,sex:"M",cc:"Unresponsive"},
scene:"Park restroom. Patient slumped on floor. Syringe and drug paraphernalia visible nearby.",
vitals:{hr:52,bp:"90/60",rr:4,spo2:78,gcs:4,temp:"97.2°F"},
history:{pmh:"IV drug use",meds:"None",allergies:"Unknown"},
presentation:"Unresponsive male with pinpoint pupils, respiratory rate of 4, cyanotic. Track marks on bilateral arms. Drug paraphernalia on scene.",
primary_protocol:"04.18A",related_protocols:["01.01","05.01A"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"What is your immediate treatment priority?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Ventilate with BVM and administer naloxone (Narcan) — titrate to respiratory effort, not full consciousness",correct:true,explanation:"Per Protocol 04.18A: Support ventilations and administer naloxone. Goal is adequate respiratory effort, NOT full alertness — over-reversal can cause acute withdrawal and agitation.",protocol_ref:"04.18A"},
   {text:"Naloxone only — ventilation isn't needed if you give Narcan quickly",correct:false,explanation:"Ventilation is critical. Naloxone takes time to work. BVM ventilation provides immediate oxygenation.",protocol_ref:"04.18A"},
   {text:"Sternal rub to wake the patient, then transport",correct:false,explanation:"Painful stimuli won't reverse opioid toxicity. This patient needs naloxone and ventilatory support.",protocol_ref:"04.18A"},
   {text:"Start CPR immediately",correct:false,explanation:"The patient has a pulse (HR 52). CPR is not indicated. Support ventilations and administer naloxone.",protocol_ref:"04.18A"}
  ]},
 {phase:"treatment",prompt:"After naloxone, the patient becomes alert and agitated. He wants to refuse transport. What do you do?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Strongly encourage transport — naloxone has a shorter duration than most opioids, re-sedation is possible",correct:true,explanation:"Naloxone's duration (30-90 min) is shorter than most opioids. The patient may re-sedate and develop respiratory failure after naloxone wears off.",protocol_ref:"04.18A"},
   {text:"He's alert and oriented, so he can refuse — sign the refusal and leave",correct:false,explanation:"While competent patients can refuse, you must explain the risk of re-sedation. Follow the Refusal Protocol thoroughly.",protocol_ref:"06.04"},
   {text:"Restrain him and transport against his will",correct:false,explanation:"A competent patient cannot be transported against their will without specific criteria being met.",protocol_ref:"06.04"},
   {text:"The naloxone cured him — no need for hospital",correct:false,explanation:"Naloxone is temporary. The opioid will outlast the naloxone.",protocol_ref:"04.18A"}
  ]}
]},

{id:"spec-hypo-01",title:"Hypothermic Patient",category:"Special",difficulty:"Medium",
dispatch:"Respond to a park bench for a homeless person found unresponsive in cold weather.",
patient:{age:58,sex:"M",cc:"Found unresponsive in cold"},
scene:"Park bench. Temperature is 28°F. Patient on bench with minimal clothing, altered mental status.",
vitals:{hr:44,bp:"88/60",rr:10,spo2:90,gcs:10,temp:"90°F"},
history:{pmh:"Unknown, suspected alcohol use disorder",meds:"Unknown",allergies:"Unknown"},
presentation:"Altered, shivering male. Cold to touch. Bradycardic. Speech confused and slurred. Mild to moderate hypothermia.",
primary_protocol:"04.13A",related_protocols:["01.01","02.05A"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"What is the priority in managing this hypothermic patient?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Remove wet clothing, prevent further heat loss, passive and active rewarming, handle gently to avoid triggering dysrhythmias",correct:true,explanation:"Per Protocol 04.13A: Remove wet clothing, insulate, passive rewarming. Handle gently — hypothermic hearts are prone to dysrhythmias with rough handling.",protocol_ref:"04.13A"},
   {text:"Vigorously rub extremities to restore circulation",correct:false,explanation:"Vigorous rubbing can push cold blood to the core and worsen hypothermia. Handle gently.",protocol_ref:"04.13A"},
   {text:"Give hot coffee to warm internally",correct:false,explanation:"No oral fluids for altered mental status patients. Also, oral rewarming is minimally effective.",protocol_ref:"04.13A"},
   {text:"Only treat in the ambulance with the heater on",correct:false,explanation:"Begin interventions immediately — remove wet clothes and insulate before/during transport.",protocol_ref:"04.13A"}
  ]},
 {phase:"treatment",prompt:"The patient's heart rate drops to 30 and the ECG shows a Junctional rhythm. What is your approach?",multi_select:false,level_filter:"CP",
  options:[
   {text:"Continue rewarming and transport — medications and pacing may be ineffective until core temperature rises above 86°F",correct:true,explanation:"Per Protocol 04.13A: Below 86°F, the heart may not respond to atropine, pacing, or defibrillation. Focus on rewarming. Withhold repeat medication dosing until rewarmed.",protocol_ref:"04.13A"},
   {text:"Atropine 1mg IV push immediately",correct:false,explanation:"Atropine is typically ineffective in hypothermia. The bradycardia is a physiologic response to cold.",protocol_ref:"04.13A"},
   {text:"Immediate transcutaneous pacing",correct:false,explanation:"Pacing may be ineffective and can trigger VF in the hypothermic heart.",protocol_ref:"04.13A"},
   {text:"Administer warm IV fluids at maximum rate to rapidly rewarm",correct:false,explanation:"Warm IV fluids are appropriate but aggressive fluid boluses are not the primary treatment for hypothermic bradycardia.",protocol_ref:"04.13A"}
  ]}
]},

{id:"spec-ob-01",title:"Imminent Delivery",category:"Special",difficulty:"Medium",
dispatch:"Respond to a vehicle on the highway for a woman in labor.",
patient:{age:30,sex:"F",cc:"In labor, baby coming"},
scene:"Pulled over on highway shoulder. Backseat of car. Woman screaming, crowning visible.",
vitals:{hr:102,bp:"128/78",rr:24,spo2:98,gcs:15},
history:{pmh:"G3P2, 39 weeks, uncomplicated pregnancy",meds:"Prenatal vitamins",allergies:"NKDA"},
presentation:"Full-term pregnancy with crowning. Contractions every 1 minute. This is her third baby. Delivery is imminent — no time for transport.",
primary_protocol:"02.17",related_protocols:["01.01","02.16"],level_min:"E",
questions:[
 {phase:"treatment",prompt:"Crowning is visible and contractions are 1 minute apart. What do you do?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Prepare for field delivery — support the head as it delivers, check for nuchal cord, suction mouth then nose, deliver shoulders with gentle downward then upward traction",correct:true,explanation:"Per Protocol 02.17: With crowning and frequent contractions, prepare for delivery. Support the head, check for nuchal cord, clear airway, deliver shoulders.",protocol_ref:"02.17"},
   {text:"Hold the baby's head and prevent delivery until you reach the hospital",correct:false,explanation:"Never hold back or delay delivery. An imminent delivery should proceed in the field.",protocol_ref:"02.17"},
   {text:"Rush to the hospital — there's always time",correct:false,explanation:"Crowning with 1-minute contractions means delivery is seconds to minutes away. Prepare for field delivery.",protocol_ref:"02.17"},
   {text:"Only a doctor can deliver a baby",correct:false,explanation:"EMS providers are trained to manage field deliveries. This baby is coming now.",protocol_ref:"02.17"}
  ]},
 {phase:"treatment",prompt:"The baby is delivered. She is limp, not crying, and appears cyanotic. What are your immediate actions?",multi_select:false,level_filter:"EACP",
  options:[
   {text:"Dry and stimulate vigorously, suction airway, keep warm, clamp and cut cord, assess for need for BVM ventilation",correct:true,explanation:"Per Protocol 02.16/02.17: Dry, stimulate, suction, keep warm. If no improvement, begin BVM ventilation at 40-60 breaths/min.",protocol_ref:"02.16"},
   {text:"Immediately clamp and cut the cord and hand to the mother",correct:false,explanation:"The priority is assessment and resuscitation of the newborn, not cord management.",protocol_ref:"02.16"},
   {text:"Wait 5 minutes — all babies look blue at first",correct:false,explanation:"A limp, non-crying, cyanotic newborn requires immediate intervention.",protocol_ref:"02.16"},
   {text:"Start chest compressions immediately",correct:false,explanation:"Start with drying, stimulation, and ventilation. Chest compressions are only for HR <60 despite adequate ventilation.",protocol_ref:"02.16"}
  ]}
]}
];
// App State
let state = {
  screen: 'home', // home, select, scenario, debrief
  level: null,
  currentScenario: null,
  questionIndex: 0,
  answers: [],
  answered: false,
  selectedOptions: new Set()
};

const app = document.getElementById('app');

function render() {
  switch(state.screen) {
    case 'home': renderHome(); break;
    case 'select': renderSelect(); break;
    case 'scenario': renderScenario(); break;
    case 'debrief': renderDebrief(); break;
  }
  window.scrollTo(0, 0);
}

function renderHome() {
  app.innerHTML = `
    <h1>🚑 RI EMS Scenario Trainer</h1>
    <p class="subtitle">Train with real Rhode Island protocols</p>
    <p style="text-align:center;color:#8b92a8;font-size:.85em;margin-bottom:24px">Select your certification level</p>
    <div class="level-cards">
      <div class="card level-card" data-level="E" onclick="selectLevel('E')">
        EMT
        <div class="desc">Emergency Medical Technician</div>
      </div>
      <div class="card level-card" data-level="A" onclick="selectLevel('A')">
        AEMT
        <div class="desc">Advanced EMT</div>
      </div>
      <div class="card level-card" data-level="C" onclick="selectLevel('C')">
        AEMT-C
        <div class="desc">Advanced EMT-Cardiac</div>
      </div>
      <div class="card level-card" data-level="P" onclick="selectLevel('P')">
        Paramedic
        <div class="desc">Paramedic</div>
      </div>
    </div>
  `;
}

function selectLevel(level) {
  state.level = level;
  state.screen = 'select';
  render();
}

function getAvailableScenarios() {
  const levelOrder = {E:1, A:2, C:3, P:4};
  const userLevel = levelOrder[state.level] || 1;
  return SCENARIOS.filter(s => {
    const minLevel = levelOrder[s.level_min] || 1;
    return userLevel >= minLevel;
  });
}

function renderSelect() {
  const scenarios = getAvailableScenarios();
  const categories = {};
  scenarios.forEach(s => {
    if (!categories[s.category]) categories[s.category] = [];
    categories[s.category].push(s);
  });

  let html = `
    <button class="back-btn" onclick="state.screen='home';render()">Back</button>
    <h1 style="font-size:1.3em;margin-bottom:4px">Choose a Scenario</h1>
    <p class="subtitle">${scenarios.length} scenarios available</p>
    <button class="btn btn-primary" onclick="startRandom()" style="margin-bottom:20px">🎲 Random Scenario</button>
  `;

  for (const [cat, items] of Object.entries(categories)) {
    html += `<div class="category-header">${cat}</div>`;
    items.forEach(s => {
      const diffClass = s.difficulty === 'Easy' ? 'tag-easy' : s.difficulty === 'Medium' ? 'tag-medium' : 'tag-hard';
      html += `
        <div class="card" onclick="startScenario('${s.id}')" style="margin-bottom:8px">
          <div class="scenario-item">
            <div>
              <div class="title">${s.title}</div>
              <div class="tags" style="margin-top:6px">
                <span class="tag ${diffClass}">${s.difficulty}</span>
                <span class="tag tag-proto">${s.primary_protocol}</span>
              </div>
            </div>
            <span style="color:#8b92a8">›</span>
          </div>
        </div>`;
    });
  }

  app.innerHTML = html;
}

function startRandom() {
  const scenarios = getAvailableScenarios();
  const s = scenarios[Math.floor(Math.random() * scenarios.length)];
  startScenario(s.id);
}

function startScenario(id) {
  state.currentScenario = SCENARIOS.find(s => s.id === id);
  state.questionIndex = 0;
  state.answers = [];
  state.answered = false;
  state.selectedOptions = new Set();
  state.screen = 'scenario';
  render();
}

function getFilteredQuestions() {
  const levelMap = {E:'E', A:'A', C:'C', P:'P'};
  const userLevel = state.level;
  return state.currentScenario.questions.filter(q => {
    return q.level_filter.includes(userLevel);
  });
}

function renderScenario() {
  const s = state.currentScenario;
  const questions = getFilteredQuestions();
  
  if (state.questionIndex >= questions.length) {
    state.screen = 'debrief';
    render();
    return;
  }

  const q = questions[state.questionIndex];
  const phases = ['scene','assessment','treatment','transport'];
  const phaseLabels = {scene:'Scene Size-Up',assessment:'Assessment',treatment:'Treatment',transport:'Transport'};
  
  // Progress bar
  let progressHtml = '<div class="progress-bar">';
  const usedPhases = [...new Set(questions.map(qq => qq.phase))];
  usedPhases.forEach(p => {
    const qIdx = questions.findIndex(qq => qq.phase === p);
    let cls = '';
    if (p === q.phase) cls = 'active';
    else if (qIdx < state.questionIndex) cls = 'done';
    progressHtml += `<div class="progress-step ${cls}">${phaseLabels[p] || p}</div>`;
  });
  progressHtml += '</div>';

  // Vitals
  let vitalsHtml = '';
  if (s.vitals && state.questionIndex === 0) {
    const v = s.vitals;
    vitalsHtml = `
      <div class="narrative">
        <div class="label">Vitals</div>
        <div class="vitals-grid">
          ${v.hr !== undefined ? `<div class="vital"><div class="val">${v.hr}</div><div class="lbl">HR</div></div>` : ''}
          ${v.bp ? `<div class="vital"><div class="val">${v.bp}</div><div class="lbl">BP</div></div>` : ''}
          ${v.rr !== undefined ? `<div class="vital"><div class="val">${v.rr}</div><div class="lbl">RR</div></div>` : ''}
          ${v.spo2 !== undefined ? `<div class="vital"><div class="val">${v.spo2}${typeof v.spo2 === 'number' ? '%' : ''}</div><div class="lbl">SpO₂</div></div>` : ''}
          ${v.gcs !== undefined ? `<div class="vital"><div class="val">${v.gcs}</div><div class="lbl">GCS</div></div>` : ''}
          ${v.temp ? `<div class="vital"><div class="val">${v.temp}</div><div class="lbl">Temp</div></div>` : ''}
          ${v.bg ? `<div class="vital"><div class="val">${v.bg}</div><div class="lbl">BG</div></div>` : ''}
        </div>
      </div>`;
  }

  // Build HTML
  let html = `
    <button class="back-btn" onclick="state.screen='select';render()">Exit Scenario</button>
    ${progressHtml}
    <div style="margin-bottom:6px"><span class="tag tag-proto">${s.primary_protocol}</span> <span style="color:#8b92a8;font-size:.85em">${s.title}</span></div>
  `;

  // Show dispatch/scene on first question
  if (state.questionIndex === 0) {
    html += `
      <div class="narrative">
        <div class="label">📟 Dispatch</div>
        ${s.dispatch}
      </div>
      <div class="narrative">
        <div class="label">🏥 Scene</div>
        ${s.scene}
      </div>
      <div class="narrative">
        <div class="label">👤 Patient</div>
        ${s.patient.age}yo ${s.patient.sex === 'M' ? 'male' : 'female'} — ${s.patient.cc}<br>
        <span style="color:#8b92a8;font-size:.9em">PMH: ${s.history.pmh} | Meds: ${s.history.meds} | Allergies: ${s.history.allergies}</span>
      </div>
      <div class="narrative">
        <div class="label">🔍 Presentation</div>
        ${s.presentation}
      </div>
      ${vitalsHtml}
    `;
  }

  html += `
    <div class="phase-label">${phaseLabels[q.phase] || q.phase}</div>
    <div class="question-prompt">Question ${state.questionIndex + 1} of ${questions.length}: ${q.prompt}</div>
  `;

  if (q.multi_select) {
    html += `<div class="multi-hint">Select all that apply</div>`;
  }

  // Options
  q.options.forEach((opt, i) => {
    let cls = 'option';
    let extra = '';
    
    if (state.answered) {
      if (opt.correct) {
        cls += ' correct';
        extra = `<div class="explanation"><span class="indicator"></span> ✅ ${opt.explanation} <span class="ref">(${opt.protocol_ref})</span></div>`;
      } else if (state.selectedOptions.has(i)) {
        cls += ' incorrect';
        extra = `<div class="explanation"><span class="indicator"></span> ❌ ${opt.explanation} <span class="ref">(${opt.protocol_ref})</span></div>`;
      }
    } else {
      if (state.selectedOptions.has(i)) cls += ' selected';
    }

    html += `
      <div class="${cls}" onclick="selectOption(${i})">
        ${opt.text}
        ${extra}
      </div>`;
  });

  // Button
  if (!state.answered) {
    const disabled = state.selectedOptions.size === 0 ? 'disabled' : '';
    html += `<button class="btn btn-primary" onclick="submitAnswer()" ${disabled}>Submit Answer</button>`;
  } else {
    const isLast = state.questionIndex + 1 >= questions.length;
    const label = isLast ? 'View Results 📊' : 'Next Question →';
    html += `<button class="btn btn-primary" onclick="nextQuestion()">${label}</button>`;
  }

  app.innerHTML = `<div class="fade-in">${html}</div>`;
}

function selectOption(i) {
  if (state.answered) return;
  const q = getFilteredQuestions()[state.questionIndex];
  if (q.multi_select) {
    if (state.selectedOptions.has(i)) state.selectedOptions.delete(i);
    else state.selectedOptions.add(i);
  } else {
    state.selectedOptions = new Set([i]);
  }
  renderScenario();
}

function submitAnswer() {
  if (state.selectedOptions.size === 0) return;
  state.answered = true;
  
  const q = getFilteredQuestions()[state.questionIndex];
  const correctIndices = new Set(q.options.map((o,i) => o.correct ? i : -1).filter(i => i >= 0));
  const selected = state.selectedOptions;
  
  // Check if correct
  let isCorrect = false;
  if (q.multi_select) {
    isCorrect = selected.size === correctIndices.size && [...selected].every(i => correctIndices.has(i));
  } else {
    isCorrect = selected.size === 1 && correctIndices.has([...selected][0]);
  }

  state.answers.push({
    question: q.prompt,
    phase: q.phase,
    correct: isCorrect,
    selected: [...selected].map(i => q.options[i].text),
    correctAnswer: q.options.filter(o => o.correct).map(o => o.text),
    protocol: q.options.find(o => o.correct)?.protocol_ref || ''
  });

  renderScenario();
}

function nextQuestion() {
  state.questionIndex++;
  state.answered = false;
  state.selectedOptions = new Set();
  render();
}

function renderDebrief() {
  const s = state.currentScenario;
  const total = state.answers.length;
  const correct = state.answers.filter(a => a.correct).length;
  const pct = total > 0 ? Math.round(correct / total * 100) : 0;
  
  let scoreClass = 'score-bad';
  if (pct >= 80) scoreClass = 'score-good';
  else if (pct >= 60) scoreClass = 'score-ok';

  let html = `
    <h1 style="font-size:1.3em;text-align:center">📊 Scenario Debrief</h1>
    <p style="text-align:center;color:#8b92a8;margin-bottom:16px">${s.title}</p>
    
    <div class="score-circle ${scoreClass}">
      ${correct}/${total}
      <div class="pct">${pct}%</div>
    </div>
    
    <p style="text-align:center;margin:16px 0;font-size:.95em">
      ${pct >= 80 ? '🎉 Excellent work! Strong protocol knowledge.' : 
        pct >= 60 ? '👍 Good effort. Review the protocols you missed.' : 
        '📚 Keep studying. Review the referenced protocols.'}
    </p>
    
    <div class="category-header">Question Review</div>
  `;

  state.answers.forEach((a, i) => {
    const icon = a.correct ? '✅' : '❌';
    html += `
      <div class="review-item">
        <div class="q">${icon} Q${i+1}: ${a.question}</div>
        <div class="your-ans ${a.correct ? '' : 'wrong'}">Your answer: ${a.selected.join(', ')}</div>
        ${!a.correct ? `<div class="correct-ans">Correct: ${a.correctAnswer.join(', ')}</div>` : ''}
        <div style="margin-top:4px"><span class="tag tag-proto">${a.protocol}</span></div>
      </div>`;
  });

  html += `
    <button class="btn btn-primary" onclick="startRandom()" style="margin-top:16px">🎲 Next Random Scenario</button>
    <button class="btn btn-secondary" onclick="startScenario('${s.id}')">🔄 Try Again</button>
    <button class="btn btn-secondary" onclick="state.screen='select';render()">← Choose Another Scenario</button>
    <button class="btn btn-secondary" onclick="state.screen='home';render()">🏠 Home</button>
    <div style="height:40px"></div>
  `;

  app.innerHTML = `<div class="fade-in">${html}</div>`;
}

// Start
render();
</script>
</body></html>
